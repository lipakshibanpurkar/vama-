<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAMA Clinic - Patient Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --light: #f8fafc;
            --dark: #1e293b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --sidebar-width: 250px;
        }
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f1f5f9;
            color: var(--dark);
        }
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        .sidebar-menu {
            padding: 15px 0;
        }
        .sidebar-menu ul {
            list-style: none;
        }
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.3s;
            min-height: 44px;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: #334155;
            color: white;
            border-left: 4px solid var(--primary);
        }
        .sidebar-menu i {
            width: 20px;
            text-align: center;
        }
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            width: 44px;
            height: 44px;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            cursor: pointer;
        }
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .sidebar-overlay.active {
            display: block;
        }
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: all 0.3s ease;
            width: calc(100% - var(--sidebar-width));
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 5px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .vama-striped {
            font-family: 'Arial Black', 'Arial', sans-serif;
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            line-height: 1;
        }
        .v {
            background-image: repeating-linear-gradient(90deg,
            #448fdf 0px 1px,
            transparent 3px 5px);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            display: inline-block;
        }
        .ama {
            background-image: repeating-linear-gradient(90deg,
            #c43753 0px 1px,
            transparent 3px 5px);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            display: inline-block;
        }
        .clinic-name {
            font-size: 14px;
            font-weight: bold;
            color: #75b0eb;
            letter-spacing: 1px;
            margin-top: 5px;
        }
        .header-title h1 {
            font-size: 1.8rem;
            color: var(--dark);
            font-weight: 600;
        }
        .header-title p {
            color: var(--secondary);
            font-size: 0.9rem;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light);
            padding: 8px 15px;
            border-radius: 30px;
            cursor: pointer;
            position: relative;
            min-height: 44px;
        }
        .user-profile img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 180px;
            padding: 10px 0;
            margin-top: 5px;
            display: none;
            z-index: 100;
        }
        .user-dropdown.active {
            display: block;
        }
        .user-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 44px;
        }
        .user-dropdown-item:hover {
            background: var(--light);
        }
        .user-dropdown-item.active {
            background: #e0f2fe;
            color: var(--primary);
            font-weight: 500;
        }
        .notification-icon {
            position: relative;
            font-size: 1.3rem;
            color: var(--secondary);
            cursor: pointer;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .page {
            display: none;
            background: white;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .page.active {
            display: block;
        }
        .page-title {
            font-size: 14px;
            color: #2c3e50;
            padding: 4px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        .registration-form {
            padding: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        .form-column {
            flex: 1;
            padding: 0 10px;
            min-width: 250px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        input, select, textarea {
            width: 100%;
            padding: 4px 7px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .form-note {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }
        .vital-signs {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 25px 0;
        }
        .section-title {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        .form-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
        }
        .btn-submit {
            background: var(--primary);
            color: white;
        }
        .btn-submit:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }
        .btn-clear {
            background: var(--danger);
            color: white;
        }
        .btn-clear:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        .appointments-container, .database-container {
            padding: 20px;
        }
        .search-container {
            background: var(--light);
            padding: 5px;
            border-radius: 1px;
            margin-bottom: 5px;
        }
        .search-box {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        .search-input input {
            width: 100%;
            padding: 6px 5px 12px 40px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        .search-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .search-input i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        .appointments-table, .database-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .appointments-table th, .database-table th {
            background: var(--primary);
            color: white;
            padding: 5px;
            text-align: left;
            font-weight: 600;
        }
        .appointments-table td, .database-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        .appointments-table tr:nth-child(even), .database-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .appointments-table tr:hover, .database-table tr:hover {
            background: #e3f2fd;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-scheduled {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status-completed {
            background: #e3f2fd;
            color: #1565c0;
        }
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        .action-icons {
            display: flex;
            gap: 5px;
        }
        .action-icon {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 32px;
            min-width: 32px;
            transition: all 0.3s;
        }
        .btn-echo {
            background: #3b82f6;
            color: white;
        }
        .btn-echo:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        .btn-consult {
            background: #10b981;
            color: white;
        }
        .btn-consult:hover {
            background: #059669;
            transform: scale(1.05);
        }
        .btn-edit {
            background: var(--warning);
            color: #212529;
        }
        .btn-delete {
            background: var(--danger);
            color: white;
        }
        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }
        .role-admin {
            background: var(--primary);
            color: white;
        }
        .role-receptionist {
            background: var(--success);
            color: white;
        }
        .mobile-cards {
            display: none;
        }
        .mobile-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .mobile-card-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        .mobile-card-row:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        .mobile-card-label {
            font-weight: 600;
            color: var(--secondary);
        }
        .mobile-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .mobile-card-actions .action-icon {
            flex: 1;
            justify-content: center;
        }
        .echo-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 5px;
            margin-bottom: 30px;
        }
        .echo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e2e8f0;
        }
        .echo-header h2 {
            font-size: 1.5rem;
            color: var(--dark);
            font-weight: 600;
        }
        
        /* Report Controls */
        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .report-controls button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
        }
        
        .edit-btn {
            background: var(--warning);
            color: white;
        }
        
        .edit-btn:hover {
            background: #e58e0c;
        }
        
        .print-btn {
            background: var(--primary);
            color: white;
        }
        
        .print-btn:hover {
            background: var(--primary-dark);
        }
        
        .pdf-btn {
            background: var(--danger);
            color: white;
        }
        
        .pdf-btn:hover {
            background: #dc2626;
        }
        
        .save-btn {
            background: var(--success);
            color: white;
        }
        
        .save-btn:hover {
            background: #0da271;
        }
        
        .report-page {
            width: 100%;
            max-width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
        }
        .report-logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #0073e6, #c43753);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
            padding: 4px;
        }
        .report-vama-center {
            flex: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .report-vama-striped {
            font-family: 'Arial Black', 'Arial', sans-serif;
            font-size: 60px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            line-height: 1;
            margin-bottom: 4px;
        }
        .report-v {
            background-image: repeating-linear-gradient(90deg,
            #448fdf 0px 1px,
            transparent 3px 5px);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            display: inline-block;
        }
        .report-ama {
            background-image: repeating-linear-gradient(90deg,
            #c43753 0px 1px,
            transparent 3px 5px);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            display: inline-block;
        }
        .report-clinic-name {
            font-size: 12px;
            font-weight: bold;
            color: #75b0eb;
            letter-spacing: 0.8px;
            margin: 0;
        }
        .report-header-right {
            text-align: right;
            font-size: 12px;
            color: #555;
        }
        .report-doctors {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            border-top: 2px solid #0073e6;
            border-bottom: 2px solid #0073e6;
            padding: 6px 0;
            position: relative;
        }
        .report-doctors::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 80%;
            background-color: #0073e6;
        }
        .report-doctor {
            width: 45%;
            font-size: 12px;
            line-height: 1.3;
            padding: 0 8px;
        }
        .report-doctor b {
            font-size: 13px;
            color: #2c3e50;
        }
        .report-patient-info {
            margin-top: 12px;
            padding: 10px;
            border-radius: 4px;
            flex-direction: row;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .report-patient-info table {
            width: 100%;
            border-collapse: collapse;
        }
        .report-patient-info td {
            padding: 4px 8px;
            vertical-align: top;
        }
        .report-patient-info b {
            color: #2c3e50;
        }
        .report-title {
            text-align: center;
            margin: 20px 0 12px;
            font-weight: bold;
            font-size: 16px;
            text-decoration: underline;
            color: #2c3e50;
        }
        .report-body {
            font-size: 13px;
            line-height: 1.5;
            padding: 0 8px;
        }
        .report-section {
            margin-bottom: 15px;
        }
        .section-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 4px;
        }
        .report-body b {
            color: #2c3e50;
        }
        .report-list {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        .report-list li {
            margin-bottom: 5px;
        }
        .report-signature {
            margin-top: 40px;
            font-size: 13px;
            text-align: right;
            padding-right: 15px;
        }
        .report-signature b {
            color: #2c3e50;
        }
        .report-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #0073e6;
            color: #fff;
            text-align: center;
            font-size: 12px;
            padding: 6px 0;
        }
        
        /* UPDATED PRINT STYLES - ONLY MIDDLE CONTENT VISIBLE */
        @media print {
            /* Hide everything by default */
            body * {
                visibility: hidden;
            }
            
            /* Show only the specific report page being printed */
            .report-page, 
            .report-page * {
                visibility: visible !important;
            }
            
            /* Position the report page properly */
            .report-page {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 15mm !important;
                background: white !important;
                box-shadow: none !important;
                page-break-after: always;
            }
            
            /* Hide all other pages and elements */
            .sidebar, .header, .page-title, .search-container, 
            .report-controls, .echo-edit-controls, .echo-container, 
            .bottom-nav, .footer, .mobile-menu-toggle, 
            .sidebar-overlay, .mobile-report-controls,
            .mobile-report-expanded, .consult-edit-controls,
            .consult-controls, .mobilereport-controls,
            #registration-page, #appointments-page, #database-page {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* Main content adjustments */
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                padding: 0 !important;
                background: white !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            .page-container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            /* Hide header, footer, patient details, and doctor signature in reports */
            .report-header,
            .report-doctors,
            .report-patient-info,
            .report-signature,
            .report-footer {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* Ensure only the report body is visible */
            .report-body {
                visibility: visible !important;
                display: block !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
                font-size: 12pt !important;
                line-height: 1.4 !important;
                color: black !important;
                background: white !important;
            }
            
            /* Ensure proper page breaks */
            .report-page:last-child {
                page-break-after: auto !important;
            }
            
            /* Hide edit mode elements */
            .editable-field .edit-hint,
            .echo-edit-controls,
            .consult-edit-controls {
                display: none !important;
            }
            
            /* Ensure text is black and readable */
            .report-page * {
                color: black !important;
                background: white !important;
            }
            
            /* Fix for patient info table */
            .report-patient-info table {
                border: none !important;
            }
            
            .report-patient-info td {
                border: none !important;
                padding: 0 !important;
            }
            
            /* Ensure sections are properly spaced */
            .report-section {
                margin-bottom: 10px !important;
            }
            
            .gap-line {
                padding-bottom: 8px !important;
            }
            
            /* Show only the report title and body */
            .report-title {
                visibility: visible !important;
                display: block !important;
                text-align: center !important;
                margin: 0 0 20px 0 !important;
                font-weight: bold !important;
                font-size: 16pt !important;
                text-decoration: underline !important;
                color: black !important;
            }
        }
        
        .hidden {
            display: none !important;
        }
        .footer {
            text-align: center;
            padding: 20px;
            background: var(--primary);
            color: white;
            font-size: 14px;
            margin-top: 30px;
            border-radius: 10px;
        }
        .patient-info-row {
            display: flex;
            margin-bottom: 8px;
        }
        .patient-info-item {
            flex: 1;
            padding: 0 10px;
        }
        .patient-info-item b {
            color: #2c3e50;
        }
        .indication-row {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table td {
            padding: 6px 10px;
            border: none;
        }
        .data-table tr:nth-child(even) {
            background-color: transparent;
        }
        .echo-edit-controls {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }
        .echo-edit-controls.active {
            display: block;
        }
        .echo-edit-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .echo-edit-btn {
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-height: 36px;
        }
        .echo-edit-btn:hover {
            background: var(--primary-dark);
        }
        
        /* NEW STYLES FOR CONSULTATION EDITABLE DROPDOWNS */
        .consult-edit-controls {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }
        
        .consult-edit-controls.active {
            display: block;
        }
        
        .consult-edit-section {
            margin-bottom: 15px;
        }
        
        .consult-edit-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .consult-edit-item {
            flex: 1;
            min-width: 200px;
        }
        
        .consult-edit-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .consult-text-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .consult-dropdown {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        
        .consult-dropdown.editable {
            border: 1px dashed #3b82f6;
            background-color: #f0f9ff;
        }
        
        .dropdown-edit-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .dropdown-edit-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .add-option-btn {
            background: #10b981;
            color: white;
        }
        
        .remove-option-btn {
            background: #ef4444;
            color: white;
        }
        
        .edit-option-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .calendar-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .gap-line {
            padding-bottom: 10px;
        }
        
        .mobile-report-controls {
            display: none;
            position: fixed;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            z-index: 1000;
            flex-direction: column;
            gap: 10px;
        }
        .mobile-report-controls.active {
            display: flex;
        }
        .mobile-report-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        .mobile-report-btn:hover {
            transform: scale(1.1);
        }
        .mobile-report-btn.save {
            background: var(--success);
        }
        .mobile-report-btn.print {
            background: var(--primary);
        }
        .mobile-report-btn.pdf {
            background: var(--danger);
        }
        .mobile-report-btn.edit {
            background: var(--warning);
        }
        .mobile-report-btn.preset {
            background: var(--secondary);
        }
        .mobile-report-btn.folder {
            background: #8b5cf6;
        }
        .mobile-report-expanded {
            display: none;
            position: fixed;
            top: 50%;
            left: 70px;
            transform: translateY(-50%);
            z-index: 1000;
            flex-direction: column;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
            width: 250px;
        }
        .mobile-report-expanded.active {
            display: flex;
        }
        .mobile-report-expanded button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: flex-start;
            min-height: 44px;
        }
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            z-index: 1000;
            padding: 5px 0;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 5px;
            text-decoration: none;
            color: var(--secondary);
            font-size: 0.7rem;
            flex: 1;
            min-height: 60px;
        }
        .bottom-nav-item.active {
            color: var(--primary);
        }
        .bottom-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }
        .follow-up-icon {
            background: #8b5cf6;
            color: white;
        }
        .follow-up-icon:hover {
            background: #7c3aed;
            transform: scale(1.05);
        }
        .see-icon {
            background: #3b82f6;
            color: white;
        }
        .see-icon:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        .follow-up-section {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .follow-up-form {
            display: none;
        }
        .follow-up-form.active {
            display: block;
        }
        .follow-up-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .follow-up-table th {
            background: #e0f2fe;
            padding: 8px 12px;
            text-align: left;
        }
        .follow-up-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        .follow-up-table tr:nth-child(even) {
            background: #f8fafc;
        }
        .follow-up-table tr:hover {
            background: #f1f5f9;
        }
        .excel-btn {
            background: #10b981;
            color: white;
        }
        .excel-btn:hover {
            background: #059669;
        }
        
        /* NEW STYLES FOR DIRECT EDITING */
        .editable-field {
            position: relative;
            cursor: text;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .editable-field:hover {
            background-color: #f0f9ff;
            outline: 1px dashed #3b82f6;
        }
        
        .editable-field.editing {
            background-color: #f0f9ff;
            outline: 2px solid #3b82f6;
        }
        
        .editable-input {
            width: 100%;
            border: none;
            background: transparent;
            font: inherit;
            color: inherit;
            padding: 2px 4px;
            outline: none;
        }
        
        .edit-hint {
            position: absolute;
            top: -20px;
            right: 0;
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            display: none;
        }
        
        .editable-field:hover .edit-hint {
            display: block;
        }
        
        /* Mobile number validation styling */
        .mobile-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .mobile-error.show {
            display: block;
        }
        
        /* Remove required field indicators */
        label.required::after {
            content: "" !important;
        }
        
        /* Admin password modal */
        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .admin-modal.active {
            display: flex;
        }
        
        .admin-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .admin-modal h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .admin-modal input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .admin-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* Preset buttons styling */
        .preset-btn {
            padding: 10px 5px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            flex: 1;
            min-width: 12px;
            justify-content: center;
        }

        .preset-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }

        .echo-edit-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary);
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary);
        }

        .close:hover {
            color: var(--dark);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #e2e8f0;
        }

        /* Folder list styling */
        .folder-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .folder-item:hover, .folder-item.active {
            background: #f0f9ff;
            border-color: var(--primary);
        }

        .folder-item i {
            color: var(--warning);
            font-size: 18px;
        }

        .folder-item span {
            font-weight: 500;
            color: var(--dark);
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .echo-edit-buttons {
                flex-direction: column;
            }
            
            .preset-btn {
                width: 100%;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            /* Mobile follow-up table fixes */
            .follow-up-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .follow-up-table th,
            .follow-up-table td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .follow-up-table th:nth-child(5),
            .follow-up-table td:nth-child(5) {
                min-width: 120px;
            }
            
            .follow-up-table th:nth-child(6),
            .follow-up-table td:nth-child(6) {
                min-width: 80px;
            }
        }
        
        /* New styles for file explorer simulation */
        .file-explorer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .file-explorer-modal.active {
            display: flex;
        }
        
        .file-explorer-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            height: 70%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .file-explorer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
        }
        
        .file-explorer-header h3 {
            margin: 0;
            color: var(--primary);
        }
        
        .file-explorer-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .file-explorer-path {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .file-explorer-path i {
            color: var(--secondary);
        }
        
        .file-explorer-folders {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .file-explorer-folder {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
            padding: 15px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-explorer-folder:hover {
            background: #f0f9ff;
        }
        
        .file-explorer-folder i {
            font-size: 40px;
            color: #fbbf24;
            margin-bottom: 8px;
        }
        
        .file-explorer-folder span {
            font-size: 12px;
            text-align: center;
            word-break: break-word;
        }
        
        .file-explorer-files {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .file-explorer-files-header {
            display: flex;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: var(--dark);
        }
        
        .file-explorer-files-header .name {
            flex: 3;
        }
        
        .file-explorer-files-header .date {
            flex: 2;
        }
        
        .file-explorer-files-header .size {
            flex: 1;
            text-align: right;
        }
        
        .file-explorer-files-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-explorer-file {
            display: flex;
            padding: 10px 15px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-explorer-file:hover {
            background: #f0f9ff;
        }
        
        .file-explorer-file.selected {
            background: #e0f2fe;
        }
        
        .file-explorer-file .name {
            flex: 3;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-explorer-file .name i {
            color: #ef4444;
        }
        
        .file-explorer-file .date {
            flex: 2;
            font-size: 14px;
            color: var(--secondary);
        }
        
        .file-explorer-file .size {
            flex: 1;
            text-align: right;
            font-size: 14px;
            color: var(--secondary);
        }
        
        .file-explorer-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8f9fa;
        }
        
        .file-name-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 15px;
        }
        
        .file-explorer-buttons {
            display: flex;
            gap: 10px;
        }
        
        .save-location-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e0f2fe;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .save-location-indicator i {
            color: var(--primary);
        }
        
        @media print {
            .report-page {
                page-break-after: always;
                page-break-inside: avoid;
            }
            .report-page:last-child {
                page-break-after: auto;
            }
        }
        @media (max-width: 992px) {
            .sidebar {
                width: 250px;
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .sidebar-header h2, .sidebar-menu span {
                display: block;
            }
            .sidebar-header {
                justify-content: flex-start;
            }
            .sidebar-menu a {
                justify-content: flex-start;
                padding: 12px 20px;
            }
            .main-content {
                margin-left: 0;
                width: 100%;
                padding-bottom: 70px;
            }
            .mobile-menu-toggle {
                display: flex;
            }
            .report-controls {
                flex-direction: column;
            }
            .report-controls button {
                width: 100%;
                justify-content: center;
            }
            .report-page {
                width: 100%;
                padding: 10px;
                min-height: auto;
                box-shadow: none;
                margin-bottom: 20px;
            }
            .report-vama-striped {
                font-size: 40px;
            }
            .report-doctors {
                flex-direction: column;
            }
            .report-doctors::before {
                display: none;
            }
            .report-doctor {
                width: 100%;
                margin-bottom: 10px;
            }
            .mobile-report-controls {
                display: flex;
            }
            .report-controls {
                display: none;
            }
            .bottom-nav {
                display: flex;
            }
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: row;
                gap: 15px;
                align-items: flex-start;
                padding: 15px;
            }
            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            .form-row {
                flex-direction: column;
                margin: 0;
            }
            .form-column {
                width: 100%;
                padding: 0;
                margin-bottom: 15px;
            }
            input, select, textarea {
                padding: 14px 12px;
            }
            .vama-striped {
                font-size: 36px;
            }
            .search-box {
                flex-direction: column;
            }
            .search-input {
                min-width: 100%;
            }
            .table-container {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            .mobile-cards {
                display: none;
            }
            .form-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
            .report-vama-striped {
                font-size: 30px;
            }
            .report-header {
                flex-direction: row;
                gap: 10px;
                text-align: center;
            }
            .report-logo {
                align-self: center;
            }
            .report-header-right {
                text-align: center;
            }
            .report-doctors {
                flex-direction: row;
                gap: 10px;
            }
            .report-doctor {
                width: 100%;
                text-align: center;
            }
            .report-doctor:last-child {
                text-align: center;
            }
            .report-patient-info table {
                display: block;
            }
            .report-patient-info tr {
                display: table-row;
                margin-bottom: 0;
                padding: 0;
                background: transparent;
                border-radius: 0;
            }
            .report-patient-info td {
                display: table-cell;
                padding: 1px 2px;
                width: auto;
                border: none;
                vertical-align: top;
            }
            .report-patient-info td:first-child {
                font-weight: 600;
                color: #2c3e50;
            }
        }
        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }
            .content {
                padding: 15px;
            }
            .header-left h1 {
                font-size: 1.5rem;
            }
            .content-header h2 {
                font-size: 1.3rem;
            }
            .user-profile span {
                display: none;
            }
            .report-vama-striped {
                font-size: 24px;
            }
            .report-clinic-name {
                font-size: 10px;
            }
            .report-doctor {
                font-size: 10px;
            }
            .report-body {
                font-size: 12px;
            }
            .registration-form {
                padding: 12px 15px;
            }
            .page-title {
                padding: 5px;
                font-size: 12px;
            }
            .vital-signs {
                padding: 15px;
            }
            .search-container {
                padding: 15px;
            }
            .echo-container, .appointments-container, .database-container {
                padding: 15px;
            }
            .bottom-nav-item {
                font-size: 0.6rem;
                padding: 5px 2px;
            }
            .bottom-nav-item i {
                font-size: 1rem;
            }
            .consult-patient-info {
                padding: 10px;
            }
            .patient-info-row {
                flex-direction: column;
                gap: 8px;
            }
            .patient-info-item {
                width: 100%;
                padding: 0;
            }
            .gap-line {
                margin: 8px 0;
                padding-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            
        </div>
        <nav class="sidebar-menu">
            <ul>
                <li><a href="#" class="active" data-page="registration"><i class="fas fa-user-plus"></i> Patient Registration</a></li>
                <li><a href="#" data-page="appointments"><i class="fas fa-calendar-check"></i> Appointments</a></li>
                <li><a href="#" data-page="echo" class="admin-only"><i class="fas fa-heartbeat"></i> Echo Reports</a></li>
                <li><a href="#" data-page="consultation" class="admin-only"><i class="fas fa-user-md"></i> Consultation</a></li>
                <li><a href="#" data-page="database" class="admin-only"><i class="fas fa-database"></i> Database</a></li>
            </ul>
        </nav>
    </div>

    <!-- Admin Password Modal -->
    <div class="admin-modal" id="admin-modal">
        <div class="admin-modal-content">
            <h2>Admin Access</h2>
            <p>Please enter the admin password:</p>
            <input type="password" id="admin-password" placeholder="Enter password">
            <div class="admin-modal-buttons">
                <button class="btn btn-submit" onclick="verifyAdminPassword()">Submit</button>
                <button class="btn btn-clear" onclick="closeAdminModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- File Explorer Modal -->
    <div class="file-explorer-modal" id="file-explorer-modal">
        <div class="file-explorer-content">
            <div class="file-explorer-header">
                <h3 id="file-explorer-title">Save PDF As</h3>
                <span class="close" onclick="closeFileExplorer()">&times;</span>
            </div>
            <div class="file-explorer-body">
                <div class="save-location-indicator">
                    <i class="fas fa-folder"></i>
                    <span id="current-location"></span>
                </div>
                
                <div class="file-explorer-path">
                    <i class="fas fa-arrow-left" onclick="navigateUp()"></i>
                    <span id="current-path"></span>
                </div>
                
                <div class="file-explorer-folders" id="folders-container">
                    <!-- Folders will be populated by JavaScript -->
                </div>
                
                <div class="file-explorer-files">
                    <div class="file-explorer-files-header">
                        <div class="name">Name</div>
                        <div class="date">Date modified</div>
                        <div class="size">Size</div>
                    </div>
                    <div class="file-explorer-files-list" id="files-container">
                        <!-- Files will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="file-explorer-footer">
                <input type="text" class="file-name-input" id="file-name-input" placeholder="File name" value="Echo_Report_John_Doe_2025-10-14.pdf">
                <div class="file-explorer-buttons">
                    <button class="btn btn-clear" onclick="closeFileExplorer()">Cancel</button>
                    <button class="btn btn-submit" onclick="savePDFWithFileExplorer()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav" id="bottom-nav">
        <a href="#" class="bottom-nav-item active" data-page="registration">
            <i class="fas fa-user-plus"></i>
            <span>Register</span>
        </a>
        <a href="#" class="bottom-nav-item" data-page="appointments">
            <i class="fas fa-calendar-check"></i>
            <span>Appointments</span>
        </a>
        <a href="#" class="bottom-nav-item admin-only" data-page="echo">
            <i class="fas fa-heartbeat"></i>
            <span>Echo</span>
        </a>
        <a href="#" class="bottom-nav-item admin-only" data-page="consultation">
            <i class="fas fa-user-md"></i>
            <span>Consult</span>
        </a>
        <a href="#" class="bottom-nav-item admin-only" data-page="database">
            <i class="fas fa-database"></i>
            <span>Database</span>
        </a>
    </nav>

    <div class="main-content" id="main-content">
        <header class="header">
            <div class="header-left">
                <div class="header-logo">
                    <div class="vama-striped">
                        <span class="v">V</span><span class="ama">AMA</span>
                        <br> <p class="clinic-name">TINY HEARTS & THE KIDNEY CLINIC</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="notification-icon">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </div>
                <div class="user-profile" id="user-profile">
                    <img src="https://ui-avatars.com/api/?name=Receptionist&background=10b981&color=fff" alt="Receptionist">
                    <span id="user-name">Receptionist <span class="role-badge role-receptionist">Receptionist</span></span>
                    <div class="user-dropdown" id="user-dropdown">
                        <div class="user-dropdown-item" data-role="admin">
                            <i class="fas fa-user-shield"></i> Admin User
                        </div>
                        <div class="user-dropdown-item active" data-role="receptionist">
                            <i class="fas fa-user-tie"></i> Receptionist
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="page-container">
            <!-- Patient Registration Page -->
            <div class="page active" id="registration-page">
                <div class="page-title">Patient Registration Form</div>
                <form class="registration-form" id="patientForm">
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-column">
                                <label for="patientId">Patient ID</label>
                                <input type="text" id="patientId" name="patientId" value="5041174" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-column">
                                <label for="firstName">First Name</label>
                                <input type="text" id="firstName" name="firstName" placeholder="Enter first name" required>
                            </div>
                            <div class="form-column">
                                <label for="lastName">Last Name</label>
                                <input type="text" id="lastName" name="lastName" placeholder="Enter last name" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-column">
                                <label for="sex">Sex</label>
                                <select id="sex" name="sex" required>
                                    <option value="" disabled selected>Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-column">
                                <label for="dob">Date of Birth</label>
                                <input type="text" id="dob" name="dob" placeholder="mm/dd/yyyy" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-column">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" placeholder="Enter email">
                            </div>
                            <div class="form-column">
                                <label for="mobile">Mobile No</label>
                                <input type="tel" id="mobile" name="mobile" placeholder="Enter mobile number" maxlength="10" required>
                                <div class="mobile-error" id="mobile-error">Please enter a valid 10-digit mobile number</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <textarea id="address" name="address" rows="3" placeholder="Enter full address" required></textarea>
                    </div>
                    <div class="vital-signs">
                        <h3 class="section-title">Vital Signs</h3>
                        <div class="form-row">
                            <div class="form-column">
                                <label for="weight">Weight (kg)</label>
                                <input type="number" id="weight" name="weight" placeholder="Enter weight" step="0.1">
                            </div>
                            <div class="form-column">
                                <label for="height">Height (cm)</label>
                                <input type="number" id="height" name="height" placeholder="Enter height" step="0.1">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-column">
                                <label for="bloodPressure">Blood Pressure</label>
                                <input type="text" id="bloodPressure" name="bloodPressure" placeholder="e.g., 120/80">
                            </div>
                            <div class="form-column">
                                <label for="heartRate">Heart Rate (BPM)</label>
                                <input type="number" id="heartRate" name="heartRate" placeholder="e.g., 72">
                            </div>
                            <div class="form-column">
                                <label for="spo2">SpO2 (%)</label>
                                <input type="number" id="spo2" name="spo2" placeholder="e.g., 98" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-column">
                                <label for="appointmentDate">Date of Appointment</label>
                                <input type="date" id="appointmentDate" name="appointmentDate" required>
                            </div>
                            <div class="form-column">
                                <label for="appointmentTime">Time of Appointment</label>
                                <select id="appointmentTime" name="appointmentTime" required>
                                    <option value="" disabled selected>--- Select Time ---</option>
                                    <option value="06:00">6:00 AM</option>
                                    <option value="06:30">6:30 AM</option>
                                    <option value="07:00">7:00 AM</option>
                                    <option value="07:30">7:30 AM</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="08:30">8:30 AM</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="09:30">09:30 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="10:30">10:30 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="11:30">11:30 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="14:30">02:30 PM</option>
                                    <option value="15:00">03:00 PM</option>
                                    <option value="15:30">03:30 PM</option>
                                    <option value="16:00">04:00 PM</option>
                                    <option value="16:30">04:30 PM</option>
                                    <option value="17:00">05:00 PM</option>
                                    <option value="17:30">05:30 PM</option>
                                    <option value="18:00">06:00 PM</option>
                                    <option value="18:30">06:30 PM</option>
                                    <option value="19:00">07:00 PM</option>
                                    <option value="19:30">07:30 PM</option>
                                    <option value="20:00">08:00 PM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-submit">
                            <i class="fas fa-check"></i> Submit
                        </button>
                        <button type="button" class="btn btn-clear" onclick="clearForm()">
                            <i class="fas fa-times"></i> Clear Form
                        </button>
                    </div>
                </form>
            </div>

            <!-- Appointments Page -->
            <div class="page" id="appointments-page">
                <div class="page-title">Appointment Management</div>
                <div class="appointments-container">
                    <div class="search-container">
                        <div class="search-box">
                            <div class="search-input">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchPatient" placeholder="Search by name, ID, or mobile...">
                            </div>
                            <div class="search-input">
                                <select id="filterStatus">
                                    <option value="all">All Appointments</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="follow-up">Follow-up</option>
                                </select>
                            </div>
                            <button class="btn excel-btn" onclick="exportAppointmentsToExcel()">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="appointments-table">
                            <thead>
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Name</th>
                                    <th>Sex</th>
                                    <th>Age</th>
                                    <th>Mobile</th>
                                    <th>Appointment Date</th>
                                    <th>Appointment Time</th>
                                    <th>Status</th>
                                    <th>Next Follow-up</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentsTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Follow-up Form Section -->
                    <div class="follow-up-section">
                        <h3>Follow-up Management</h3>
                        <div class="follow-up-form" id="follow-up-form">
                            <div class="form-row">
                                <div class="form-column">
                                    <label for="follow-up-patient-id">Patient ID</label>
                                    <input type="text" id="follow-up-patient-id" readonly>
                                </div>
                                <div class="form-column">
                                    <label for="follow-up-patient-name">Patient Name</label>
                                    <input type="text" id="follow-up-patient-name" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-column">
                                    <label for="follow-up-date">Follow-up Date</label>
                                    <input type="date" id="follow-up-date" required>
                                </div>
                                <div class="form-column">
                                    <label for="follow-up-time">Follow-up Time</label>
                                    <select id="follow-up-time" required>
                                        <option value="" disabled selected>--- Select Time ---</option>
                                        <option value="09:00">09:00 AM</option>
                                        <option value="09:30">09:30 AM</option>
                                        <option value="10:00">10:00 AM</option>
                                        <option value="10:30">10:30 AM</option>
                                        <option value="11:00">11:00 AM</option>
                                        <option value="11:30">11:30 AM</option>
                                        <option value="12:00">12:00 PM</option>
                                        <option value="14:00">02:00 PM</option>
                                        <option value="14:30">02:30 PM</option>
                                        <option value="15:00">03:00 PM</option>
                                        <option value="15:30">03:30 PM</option>
                                        <option value="16:00">04:00 PM</option>
                                        <option value="16:30">04:30 PM</option>
                                        <option value="17:00">05:00 PM</option>
                                        <option value="17:30">05:30 PM</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-column">
                                    <label for="follow-up-reason">Reason for Follow-up</label>
                                    <textarea id="follow-up-reason" rows="3" placeholder="Enter reason for follow-up"></textarea>
                                </div>
                            </div>
                            <div class="form-buttons">
                                <button type="button" class="btn btn-submit" onclick="saveFollowUp()">
                                    <i class="fas fa-check"></i> Save Follow-up
                                </button>
                                <button type="button" class="btn btn-clear" onclick="cancelFollowUp()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                        
                        <!-- Follow-up Table -->
                        <div class="follow-up-table-container">
                            <h4>Upcoming Follow-ups</h4>
                            <table class="follow-up-table">
                                <thead>
                                    <tr>
                                        <th>Patient ID</th>
                                        <th>Name</th>
                                        <th>Follow-up Date</th>
                                        <th>Follow-up Time</th>
                                        <th>Reason</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="follow-up-table-body">
                                    <!-- Follow-up rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Echo Reports Page -->
            <div class="page" id="echo-page">
                <div class="page-title">Echocardiography Reports</div>

                <!-- Search for Patient -->
                <div class="search-container">
                    <div class="search-box">
                        <div class="search-input">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchEchoPatient" placeholder="Search by Patient ID or Name...">
                        </div>
                        <button class="btn btn-submit" onclick="searchEchoPatient()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>

                <!-- Echo Report Controls -->
                <div class="report-controls" id="echo-controls">
                    <button class="edit-btn" onclick="toggleEchoEditMode()">
                        <i class="fas fa-edit"></i> Edit Report
                    </button>
                    <button class="print-btn" onclick="printEchoReport()">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                    <button class="pdf-btn" onclick="saveEchoAsPDF()">
                        <i class="fas fa-file-pdf"></i> Save as PDF
                    </button>
                    <button class="save-btn" id="save-echo-btn" style="display:none;" onclick="saveEchoReport()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>

                <!-- Echo Preset Controls -->
                <div class="echo-edit-controls" id="echo-preset-controls" style="display: none;">
                    <div class="echo-edit-buttons">
                        <button class="preset-btn" onclick="applyEchoPreset('Normal')">
                            <i class="fas fa-heartbeat"></i> Normal
                        </button>
                        <button class="preset-btn" onclick="applyEchoPreset('ASD')">
                            <i class="fas fa-heart"></i> ASD
                        </button>
                        <button class="preset-btn" onclick="applyEchoPreset('PDA')">
                            <i class="fas fa-heart"></i> PDA
                        </button>
                        <button class="preset-btn" onclick="applyEchoPreset('VSD')">
                            <i class="fas fa-heart"></i> VSD
                        </button>
                        <button class="preset-btn" onclick="applyEchoPreset('TOF')">
                            <i class="fas fa-heart"></i> TOF
                        </button>
                        <button class="preset-btn" onclick="applyEchoPreset('AP window')">
                            <i class="fas fa-heart"></i> AP Window
                        </button>
                        <button class="preset-btn" onclick="applyEchoPreset('TGA')">
                            <i class="fas fa-heart"></i> TGA
                        </button>
                        <button class="preset-btn" onclick="applyEchoPreset('TAPVC')">
                            <i class="fas fa-heart"></i> TAPVC
                        </button>
                    </div>
                </div>

                <!-- Report Page -->
                <div class="report-page" id="report-page">
                    <div class="report-header">
                        <div class="report-logo">
                            <span>VAMA<br>CLINIC</span>
                        </div>
                        <div class="report-vama-center">
                            <div class="report-vama-striped">
                                <span class="report-v">V</span><span class="report-ama">AMA</span>
                            </div>
                            <p class="report-clinic-name">TINY HEARTS & THE KIDNEY CLINIC</p>
                        </div>
                        <div class="report-header-right">
                            <div>Echocardiography Report</div>
                            <div id="report-date">Date: 12-09-2025</div>
                        </div>
                    </div>
                    <div class="report-doctors">
                        <div class="report-doctor">
                            <b>Dr. Madhavi Dadwe</b><br>
                            MBBS MD DrNB (Nephrology)<br>
                            Consultant Nephrologist & Transplant Physician<br>
                            +91 91725 20489<br>
                            vamathekidneyclinic@gmail.com
                        </div>
                        <div class="report-doctor" style="text-align:right;">
                            <b>Dr. Ashishkumar Banpurkar</b><br>
                            MBBS MD DrNB (Pediatric Cardiology)<br>
                            Consultant Fetal & Pediatric Cardiologist<br>
                            +91 93709 94757<br>
                            vamatinyhearts@gmail.com
                        </div>
                    </div>
                    <!-- Patient Info -->
                    <div class="report-patient-info">
                        <table>
                            <tr>
                                <td><b>Patient ID:</b> <span id="echo-patient-id">5041174</span></td>
                                <td><b>Name:</b> <span id="echo-patient-name">John Doe</span></td>
                                <td><b>Date:</b> <span id="echo-report-date">12-09-2025</span></td>
                            </tr>
                            <tr>
                                <td><b>Age:</b> <span id="echo-patient-age">8 years</span></td>
                                <td><b>HR:</b> <span id="echo-patient-hr">72 BPM</span></td>
                                <td><b>Indication:</b> <span id="echo-indication">Incidental Detection of murmur</span></td>
                            </tr>
                            <tr>
                                <td><b>Weight:</b> <span id="echo-patient-weight">25 Kg</span></td>
                                <td><b>Ref:</b> <span id="echo-ref">Shubham Bafna Sir</span></td>
                                <td><b>BP:</b> <span id="echo-patient-bp">110/70 mmHg</span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="report-title">ECHOCARDIOGRAPHY REPORT</div>
                    <div class="report-body" id="report-body">
                        <div class="report-section">
                            <div class="section-title">Echocardiography Diagnosis</div>
                            <div id="echo-diagnosis">
                                <p>STRUCTURALLY NORMAL HEART</p>
                                <p>CHAMBERS AND SEPTUM: - Left atrium: Normal size - Right atrium: Normal size - Left ventricle: Normal dimensions and wall thickness - Right ventricle: Normal dimensions - Interatrial septum: Intact - Interventricular septum: Intact</p>
                                <p>VALVES: - Mitral valve: Normal morphology, no regurgitation - Tricuspid valve: Normal morphology, no regurgitation - Aortic valve: Normal morphology, no stenosis/regurgitation - Pulmonary valve: Normal morphology</p>
                                <p>GREAT VESSELS: - Aorta: Normal dimensions, left aortic arch - Pulmonary artery: Normal dimensions, confluent branch PAs - No evidence of coarctation or PDA</p>
                                <p>VENTRICULAR FUNCTION: - Left ventricular systolic function: Normal (EF 60-65%) - Right ventricular systolic function: Normal - No regional wall motion abnormalities</p>
                                <p>PERICARDIUM: - No pericardial effusion - Normal pericardial thickness</p>
                                <p>CORONARY ARTERIES: - Normal origin and course</p>
                            </div>
                        </div>
                        <div class="report-section">
                            <div class="section-title">Impression</div>
                            <div id="echo-impression">
                                <p>Normal echocardiographic study with no significant structural or functional abnormalities detected.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Doctor signature -->
                    <div class="report-signature">
                        <b>Dr Ashishkumar Banpurkar</b><br>
                        MBBS MD DrNB (Pediatric Cardiology)<br>
                        Consultant Pediatric & Fetal Cardiologist
                    </div>
                    <!-- Footer -->
                    <div class="report-footer">
                        Vama Tiny Hearts & The Kidney Clinic | 203, 2nd Floor, City centre Opp. Vaibhav Talkies, Hadapsar Pune 411028
                    </div>
                </div>
            </div>

            <!-- Consultation Page -->
            <div class="page" id="consultation-page">
                <div class="page-title">Consultation Reports</div>

                <!-- Search for Patient -->
                <div class="search-container">
                    <div class="search-box">
                        <div class="search-input">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchConsultPatient" placeholder="Search by Patient ID or Name...">
                        </div>
                        <button class="btn btn-submit" onclick="searchConsultPatient()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                
                <!-- Consultation Report Controls -->
                <div class="report-controls" id="consult-controls">
                    <button class="edit-btn" onclick="toggleConsultEditMode()">
                        <i class="fas fa-edit"></i> Edit Report
                    </button>
                    <button class="print-btn" onclick="printConsultReport()">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                    <button class="pdf-btn" onclick="saveConsultAsPDF()">
                        <i class="fas fa-file-pdf"></i> Save as PDF
                    </button>
                    <button class="save-btn" id="save-consult-btn" style="display:none;" onclick="saveConsultReport()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                
                <!-- Consultation Edit Controls -->
                <div class="consult-edit-controls" id="consult-edit-controls">
                    <div class="consult-edit-section">
                        <h3>Edit Consultation Details</h3>
                        <div class="consult-edit-row">
                            <div class="consult-edit-item">
                                <label for="edit-anc">ANC Details</label>
                                <select id="edit-anc" class="consult-dropdown editable" onchange="updateConsultField('anc', this.value)">
                                    <option value="Not Significant">Not Significant</option>
                                    <option value="GDM">GDM</option>
                                    <option value="PIH">PIH</option>
                                    <option value="Hypothyroidism">Hypothyroidism</option>
                                </select>
                                <div class="dropdown-edit-controls">
                                    <input type="text" id="new-anc-option" class="edit-option-input" placeholder="Add new option">
                                    <button class="dropdown-edit-btn add-option-btn" onclick="addDropdownOption('anc')">Add</button>
                                    <button class="dropdown-edit-btn remove-option-btn" onclick="removeDropdownOption('anc')">Remove</button>
                                </div>
                            </div>
                            <div class="consult-edit-item">
                                <label for="edit-perinatal">Perinatal Details</label>
                                <select id="edit-perinatal" class="consult-dropdown editable" onchange="updateConsultField('perinatal', this.value)">
                                    <option value="FT/AGA/LSCS/CIAB/B Weight - /No NICU Stay">FT/AGA/LSCS/CIAB/B Weight - /No NICU Stay</option>
                                    <option value="FT/AGA/NSD/CIAB/B Weight - /No NICU Stay">FT/AGA/NSD/CIAB/B Weight - /No NICU Stay</option>
                                    <option value="PT/AGA/LSCS/CIAB/B Weight - /NICU Stay">PT/AGA/LSCS/CIAB/B Weight - /NICU Stay</option>
                                </select>
                                <div class="dropdown-edit-controls">
                                    <input type="text" id="new-perinatal-option" class="edit-option-input" placeholder="Add new option">
                                    <button class="dropdown-edit-btn add-option-btn" onclick="addDropdownOption('perinatal')">Add</button>
                                    <button class="dropdown-edit-btn remove-option-btn" onclick="removeDropdownOption('perinatal')">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="consult-edit-row">
                            <div class="consult-edit-item">
                                <label for="edit-device">Device Type</label>
                                <select id="edit-device" class="consult-dropdown editable" onchange="updateConsultField('device', this.value)">
                                    <option value="No Device">No Device</option>
                                    <option value="Pacemaker">Pacemaker</option>
                                    <option value="ICD">ICD</option>
                                    <option value="CRT">CRT</option>
                                </select>
                                <div class="dropdown-edit-controls">
                                    <input type="text" id="new-device-option" class="edit-option-input" placeholder="Add new option">
                                    <button class="dropdown-edit-btn add-option-btn" onclick="addDropdownOption('device')">Add</button>
                                    <button class="dropdown-edit-btn remove-option-btn" onclick="removeDropdownOption('device')">Remove</button>
                                </div>
                            </div>
                            <div class="consult-edit-item">
                                <label for="edit-suck-cycle">Suck-Peat-Suck Cycle</label>
                                <select id="edit-suck-cycle" class="consult-dropdown editable" onchange="updateConsultField('suck-cycle', this.value)">
                                    <option value="">-- Select --</option>
                                    <option value="Normal">Normal</option>
                                    <option value="Abnormal">Abnormal</option>
                                    <option value="Not Assessed">Not Assessed</option>
                                </select>
                                <div class="dropdown-edit-controls">
                                    <input type="text" id="new-suck-cycle-option" class="edit-option-input" placeholder="Add new option">
                                    <button class="dropdown-edit-btn add-option-btn" onclick="addDropdownOption('suck-cycle')">Add</button>
                                    <button class="dropdown-edit-btn remove-option-btn" onclick="removeDropdownOption('suck-cycle')">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="consult-edit-row">
                            <div class="consult-edit-item">
                                <label for="edit-medication1">Medications</label>
                                <select id="edit-medication1" class="consult-dropdown editable" onchange="updateConsultField('medication1', this.value)">
                                    <option value="NA">NA</option>
                                    <option value="Aspirin">Aspirin</option>
                                    <option value="Clopidogrel">Clopidogrel</option>
                                    <option value="Warfarin">Warfarin</option>
                                    <option value="Digoxin">Digoxin</option>
                                </select>
                                <div class="dropdown-edit-controls">
                                    <input type="text" id="new-medication1-option" class="edit-option-input" placeholder="Add new option">
                                    <button class="dropdown-edit-btn add-option-btn" onclick="addDropdownOption('medication1')">Add</button>
                                    <button class="dropdown-edit-btn remove-option-btn" onclick="removeDropdownOption('medication1')">Remove</button>
                                </div>
                            </div>
                            <div class="consult-edit-item">
                                <label for="edit-advice">Advice</label>
                                <select id="edit-advice" class="consult-dropdown editable" onchange="updateConsultField('advice', this.value)">
                                    <option value="Routine Neonatal Care, Immunisation as per schedule, Avoid Contact Sports X 1 month, Regular Diet, To Review with Consultant Neonatologist/Pediatrician">Routine Neonatal Care, Immunisation as per schedule, Avoid Contact Sports X 1 month, Regular Diet, To Review with Consultant Neonatologist/Pediatrician</option>
                                    <option value="Regular follow-up, Medication adherence, Lifestyle modifications">Regular follow-up, Medication adherence, Lifestyle modifications</option>
                                    <option value="Surgical consultation advised">Surgical consultation advised</option>
                                </select>
                                <div class="dropdown-edit-controls">
                                    <input type="text" id="new-advice-option" class="edit-option-input" placeholder="Add new option">
                                    <button class="dropdown-edit-btn add-option-btn" onclick="addDropdownOption('advice')">Add</button>
                                    <button class="dropdown-edit-btn remove-option-btn" onclick="removeDropdownOption('advice')">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="consult-edit-row">
                            <div class="consult-edit-item">
                                <label for="edit-other-significant">Other Significant</label>
                                <input type="text" id="edit-other-significant" class="consult-text-input" 
                                       oninput="updateConsultField('other-significant', this.value)" 
                                       placeholder="Enter other significant details">
                            </div>
                            <div class="consult-edit-item">
                                <label for="edit-echo">ECHO</label>
                                <input type="text" id="edit-echo" class="consult-text-input" 
                                       oninput="updateConsultField('echo', this.value)" 
                                       value="Large sized perimenbranous ventricular septal defect with left to right shunt">
                            </div>
                        </div>
                        
                        <div class="consult-edit-row">
                            <div class="consult-edit-item">
                                <label for="edit-ecg">ECG</label>
                                <input type="text" id="edit-ecg" class="consult-text-input" 
                                       oninput="updateConsultField('ecg', this.value)" 
                                       value="-">
                            </div>
                            <div class="consult-edit-item">
                                <label for="edit-followup">Next Follow-up</label>
                                <input type="date" id="edit-followup" class="calendar-input" 
                                       onchange="updateConsultField('followup', this.value)">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Consultation Report -->
                <div class="report-page" id="consultation-report-page">
                    <div class="report-header">
                        <div class="report-logo">
                            <span>VAMA<br>CLINIC</span>
                        </div>
                        <div class="report-vama-center">
                            <div class="report-vama-striped">
                                <span class="report-v">V</span><span class="report-ama">AMA</span>
                            </div>
                            <p class="report-clinic-name">TINY HEARTS & THE KIDNEY CLINIC</p>
                        </div>
                        <div class="report-header-right">
                            <div>Consultant Report</div>
                            <div id="consult-report-date">Date: 12-09-2025</div>
                        </div>
                    </div>
                    <div class="report-doctors">
                        <div class="report-doctor">
                            <b>Dr. Madhavi Dadwe</b><br>
                            MBBS MD DrNB (Nephrology)<br>
                            Consultant Nephrologist & Transplant Physician<br>
                            +91 91725 20489<br>
                            vamathekidneyclinic@gmail.com
                        </div>
                        <div class="report-doctor" style="text-align:right;">
                            <b>Dr. Ashishkumar Banpurkar</b><br>
                            MBBS MD DrNB (Pediatric Cardiology)<br>
                            Consultant Fetal & Pediatric Cardiologist<br>
                            +91 93709 94757<br>
                            vamatinyhearts@gmail.com
                        </div>
                    </div>
                    <!-- Patient Info with Indication -->
                    <div class="report-patient-info consult-patient-info">
                        <div class="patient-info-row">
                            <div class="patient-info-item">
                                <b>Patient ID:</b> <span id="consult-patient-id">5041174</span>
                            </div>
                            <div class="patient-info-item">
                                <b>Patient Name:</b> <span id="consult-patient-name">John Doe</span>
                            </div>
                            <div class="patient-info-item">
                                <b>Report Date:</b> <span id="consult-report-date-value">12-09-2025</span>
                            </div>
                        </div>

                        <div class="patient-info-row">
                            <div class="patient-info-item">
                                <b>Age:</b> <span id="consult-patient-age">8 years / Male</span>
                            </div>
                            <div class="patient-info-item">
                                <b>Ref:</b> <span id="consult-ref">Dr. Shubham Bafna</span>
                            </div>
                            <div class="patient-info-item">
                                <b>Murmur:</b> <span id="consult-murmur">No Murmur</span>
                            </div>
                        </div>
                        <div class="gap-line"></div>
                        <div class="patient-info-row">
                            <div class="patient-info-item">
                                <b>Indication:</b> <span id="consult-indication">Routine Checkup</span>
                            </div>
                            <div class="patient-info-item">
                                <b>S1:</b> <span id="consult-s1">Normal</span>
                            </div>
                            <div class="patient-info-item">
                                <b>S2:</b> <span id="consult-s2">Normal</span>
                            </div>
                        </div>
                    </div>
                    <div class="report-title">CONSULTATION REPORT</div>
                    <div class="report-body">
                        <!-- ANC and Perinatal Details -->
                        <div class="report-section">
                            <div class="gap-line">
                                <b>ANC Detail:</b> <span id="consult-anc">Not Significant</span>
                            </div>
                            <div class="gap-line">
                                <b>Perinatal Detail:</b> <span id="consult-perinatal">FT/AGA/LSCS/CIAB/B Weight - /No NICU Stay</span>
                            </div>
                        </div>
                        <!-- Device Section -->
                        <div class="report-section">
                            <div class="gap-line">
                                <b>Device Type:</b> <span id="consult-device">No Device</span>
                            </div>
                        </div>
                        <!-- Symptoms Section -->
                        <div class="report-section">
                            <div class="gap-line">
                                <b>Suck-Peat-Suck Cycle:</b> <span id="consult-suck-cycle"></span>
                            </div>
                            <div class="gap-line">
                                <b>Other Significant:</b> <span id="consult-other-significant"></span>
                            </div>
                            <div class="gap-line">
                                <b>ECHO:</b> <span id="consult-echo">Large sized perimenbranous ventricular septal defect with left to right shunt</span>
                            </div>
                            <div class="gap-line">
                                <b>ECG:</b> <span id="consult-ecg">-</span>
                            </div>
                        </div>
                        <!-- Medications Section -->
                        <div class="report-section">
                            <div class="gap-line">
                                <b>Medications:</b> <span id="consult-medication1">NA</span>
                            </div>
                        </div>
                        <!-- Advice Section -->
                        <div class="report-section">
                            <div class="gap-line">
                                <b>Advice:</b> <span id="consult-advice">Routine Neonatal Care, Immunisation as per schedule, Avoid Contact Sports X 1 month, Regular Diet, To Review with Consultant Neonatologist/Pediatrician</span>
                            </div>
                        </div>
                        <!-- Next Follow-up Section -->
                        <div class="report-section">
                            <div class="gap-line">
                                <b>Next Follow-up:</b> <span id="consult-followup">1 week</span>
                            </div>
                        </div>
                    </div>
                    <!-- Doctor signature -->
                    <div class="report-signature">
                        <b>Dr Ashishkumar M Banpurkar</b><br>
                        MBBS, MD, DNB (Pediatric Cardiology)<br>
                        Consultant Pediatric & Fetal Cardiologist
                    </div>
                    <!-- Footer -->
                    <div class="report-footer">
                        Vama Tiny Hearts & The Kidney Clinic | 203, 2nd Floor, City centre Opp. Vaibhav Talkies, Hadapsar Pune 411028
                    </div>
                </div>
            </div>

            <!-- Database Page -->
            <div class="page" id="database-page">
                <div class="page-title">Patient Database</div>
                <div class="database-container">
                    <div class="search-container">
                        <div class="search-box">
                            <div class="search-input">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchDatabase" placeholder="Search by name, ID, or mobile...">
                            </div>
                            <div class="search-input">
                                <select id="filterDatabase">
                                    <option value="all">All Records</option>
                                    <option value="registration">Registration</option>
                                    <option value="echo">Echo Reports</option>
                                    <option value="consultation">Consultation</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-box">
                            <button class="btn excel-btn" onclick="exportPatientDataToExcel()">
                                <i class="fas fa-file-excel"></i> Export Patient Data
                            </button>
                            <button class="btn excel-btn" onclick="exportEchoReportsToExcel()">
                                <i class="fas fa-file-excel"></i> Export Echo Reports
                            </button>
                            <button class="btn excel-btn" onclick="exportConsultationReportsToExcel()">
                                <i class="fas fa-file-excel"></i> Export Consultation Reports
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="database-table">
                            <thead>
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Name</th>
                                    <th>Sex</th>
                                    <th>Age</th>
                                    <th>Mobile</th>
                                    <th>Registration Date</th>
                                    <th>Echo Report</th>
                                    <th>Consultation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="databaseTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            Vama Tiny Hearts & The Kidney Clinic | 203, 2nd Floor, City centre Opp. Vaibhav Talkies, Hadapsar Pune 411028
        </div>
    </div>

    <script>
        // Global variable to track current user role
        let currentUserRole = 'receptionist'; // Default to receptionist

        // Role-based permissions
        const rolePermissions = {
            receptionist: {
                mainMenu: ['registration', 'appointments'],
                accessiblePages: ['registration', 'appointments', 'echo', 'consultation']
            },
            admin: {
                mainMenu: ['echo', 'consultation', 'database'],
                accessiblePages: ['echo', 'consultation', 'database']
            }
        };

        // Initialize patients array
        let patients = JSON.parse(localStorage.getItem('vamaPatients')) || [
            {
                id: "5041174",
                firstName: "John",
                lastName: "Doe",
                sex: "male",
                dob: "05/15/2017",
                email: "john.doe@example.com",
                mobile: "9876543210",
                address: "123 Main Street, Pune",
                weight: "25",
                height: "120",
                bloodPressure: "110/70",
                heartRate: "72",
                spo2: "98",
                appointmentDate: "2025-10-07",
                appointmentTime: "10:00",
                status: "scheduled",
                echoReports: [],
                consultations: [],
                followUps: []
            }
        ];

        // Echo preset data
        const echoPresets = {
            'Normal': {
                diagnosis: `**Normal study**\n\n**Findings:**\n\nStructurally normal heart\n\nIntact interatrial septum\n\nIntact interventricular septum\n\nLaminar Inflows and Outflows\n\nNormal Related Great Arteries\n\nTricuspid Aortic Valve, No AS/AR\n\nNormal coronaries\n\nConfluent and good sized branch pulmonary arteries\n\nLeft aortic arch, No CoA/PDA/LSVC\n\nGood biventricular function\n\nNo pleural/pericardial effusion`,
                impression: '**Impression:** Normal Study'
            },
            'ASD': {
                diagnosis: `**ASD**\n\n**Findings:**\n\nCongenital Heart Defect\n\nLarge sized Ostium secundum atrial septal defect with left to right shunt\n\nDilated right atrium and left ventricle\n\nLaminar Inflows\n\nMild Tricuspid Regurgitation with peak PG = mm Hg\n\nNormally related great arteries\n\nConfluent and good sized branch pulmonary arteries\n\nLeft aortic arch, No coarctation\n\nNo PDA, No LSVC\n\nGood biventricular function`,
                impression: '**Impression:** Large sized Ostium secundum atrial septal defect with left to right shunt, Dilated right atrium and left ventricle, Normal Function'
            },
            'PDA': {
                diagnosis: `**PDA**\n\n**Findings:**\n\nCongenital Heart Defect\n\nThere is a Moderate sized patent ductus arteriosus (PDA) with left to right shunt\n\nThere is systolic peak gradient of mmHg and diastolic peak gradient of mmHg across the patent ductus arteriosus\n\nThere is mild left atrial and ventricular dilatation\n\nIntact Interatrial Septum\n\nLaminar Inflows and outflows\n\nNormally Related Great arteries\n\nConfluent and good Sized branch Pulmonary arteries\n\nNo mitral or tricuspid Regurgitation\n\nLeft arch with normal branching pattern\n\nNo Coarctation / No LSVC\n\nGood biventricular function`,
                impression: '**Impression:** Moderate sized patent ductus arteriosus (PDA) with left to right shunt, Dilated left atrium and ventricle, Normal Biventricular function'
            },
            'VSD': {
                diagnosis: `**VSD**\n\n**Findings:**\n\nCongenital Heart Defect\n\nSitus, Solitus, Levocardia\n\nNormal systemic, pulmonary venous drainage\n\nLarge sized perimembranous ventricular septal defect with left to right shunt\n\nDilated Left atrium and left ventricle\n\nNormally related great arteries\n\nTricuspid Aortic Valve, No AS/AR\n\nConfluent and good sized branch pulmonary arteries\n\nLeft aortic arch, No coarctation\n\nNo PDA, No LSVC\n\nGood biventricular function`,
                impression: '**Impression:** Large sized perimembranous ventricular septal defect with left to right shunt, Dilated Left atrium and left ventricle, Normal Function'
            },
            'TOF': {
                diagnosis: `**TOF**\n\n**Findings:**\n\nCongenital heart defect\n\nTetralogy of Fallot (TOF)\n\nThere is a large subaortic ventricular septal defect (VSD) that has bidirectional shunting across it\n\nThere is severe infundibular and pulmonary valvar stenosis with a peak gradient of mmHg.\n\nSmall ostium secundum Atrial Septal Defect with left to right shunt\n\nLaminar inflows\n\nNo mitral or Tricuspid Regurgitation\n\nNormally related great vessels\n\nTricuspid Aortic Valve, Dilated Aortic Root\n\nConfluent and good sized branch pulmonary arteries\n\nNormal coronaries\n\nLeft aortic arch, No PDA, No LSVC\n\nThe biventricular function appears normal.`,
                impression: '**Impression:** TOF, Large Subaortic VSD, Severe Valvar and infundibular Pulmonary Stenosis, Confluent and good sized branch PAs, No Coronary crossing RVOT, Normal Function'
            },
            'AP window': {
                diagnosis: `**AP window**\n\n**Findings:**\n\nCongenital heart defect\n\nThere is large distal type of aortopulmonary window with left to right shunt with no gradient across AP window (peak 10mmhg)\n\nDilated left atrium and left ventricle\n\nDiastolic antegrade flows seen in RPA\n\nEarly diastolic flow reversal in arch\n\nTrivial tricuspid regurgitation with peak gradient of 50mmHg\n\nSevere pulmonary hypertension\n\nIntact Interatrial Septum, Intact Interventricular Septum\n\nNormal Related Great Arteries\n\nNormal coronaries\n\nLeft aortic arch, No CoA/PDA/LSVC\n\nNo pleural/pericardial effusion\n\nGood biventricular function`,
                impression: '**Impression:** Large distal type of aortopulmonary window with left to right shunt , Dilated left atrium and left ventricle, Normal Function'
            },
            'TGA': {
                diagnosis: `**TGA**\n\n**Findings:**\n\nCongenital Heart Defect\n\nTransposition of great arteries\n\nStretched PFO shunting left to right\n\nLaminar inflows\n\nNo Mitral or Tricuspid Regurgitation\n\nSmall perimembranous VSD shunting bilaterally\n\nSide by Side by Great Vessels\n\nTricuspid Aortic Valve, Tricuspid Pulmonary Valve\n\nLaminar Outflows\n\nCoronary artery origin 1 LCX, 2R\n\nSevere Pulmonary Hypertension\n\nConfluent and Dilated Branch Pulmonary Arteries\n\nTiny PDA shunting bidirectionally\n\nLeft Aortic Arch, No CoA/LSVC\n\nNormal ventricular function`,
                impression: '**Impression:** Transposition of great arteries, Stretched PFO shunting left to right, Small perimembranous VSD shunting bilaterally, Tiny PDA shunting bidirectionally, 1LCx 2R, Side by Side great vessels, Normal Function'
            },
            'TAPVC': {
                diagnosis: `**TAPVC**\n\nCongenital heart defect\n\nObstructed supra cardiac Total Anomalous Pulmonary Venous Connection\n\nAll four pulmonary veins join a confluence and drain into innominate veins and drains into vertical vein without obstructions\n\nVery small atrial septal defect with right to left shunt\n\nLaminar Inflows\n\nMild Tricuspid regurgitation with peak PG =\n\nNo Mitral regurgitation\n\nIntact interventricular Septum\n\nSignificantly dilated Right Atrium /Right Ventricle\n\nNormally related Great Vessels\n\nTricuspid Aortic Valve, No AS/AR\n\nConfluent Pulmonary Arteries\n\nSevere Pulmonary hypertension\n\nLeft Aortic Arch, No CoA/PDA/LSVC\n\nMild Right ventricle dysfunction\n\nNormal Left Ventricular function`,
                impression: '**Impression:** Obstructed supra cardiac Total Anomalous Pulmonary Venous Connection, Very small atrial septal defect with right to left shunt, Mild Tricuspid regurgitation with peak PG = , Significantly dilated Right Atrium /Right Ventricle, Severe Pulmonary hypertension,Mild Right ventricle dysfunction'
            }
        };

        // Global variables for file explorer
        let currentReportType = '';
        let currentLocation = 'Downloads';
        let currentPath = ['This PC', 'Downloads'];
        
        // File system structure simulation
        const fileSystem = {
            'This PC': {
                'Downloads': {
                    'Echo_Report_John_Doe_2025-10-14.pdf': { type: 'file', size: '245 KB', date: '10/14/2025 4:16 PM' },
                    'data (1)': { type: 'file', size: '1.2 MB', date: '10/14/2025 2:08 PM' },
                    'Echo_5041174_John_Doe_12-09-2025': { type: 'file', size: '312 KB', date: '10/13/2025 3:24 PM' }
                },
                'Documents': {
                    'Work': { type: 'folder' },
                    'Personal': { type: 'folder' }
                },
                'Desktop': {
                    'Projects': { type: 'folder' },
                    'Reports': { type: 'folder' }
                },
                'Pictures': {
                    'Screenshots': { type: 'folder' }
                }
            }
        };

        // NEW FUNCTIONS FOR CONSULTATION REPORT CONTROLS
        let consultEditMode = false;
        let originalConsultContent = {};

        function toggleConsultEditMode() {
            consultEditMode = !consultEditMode;
            const saveBtn = document.getElementById('save-consult-btn');
            const editBtn = document.querySelector('#consult-controls .edit-btn');
            const editControls = document.getElementById('consult-edit-controls');
            
            if (consultEditMode) {
                // Enter edit mode
                enableConsultEditing();
                saveBtn.style.display = 'flex';
                editBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Edit';
                editBtn.style.background = '#6c757d';
                editControls.classList.add('active');
                showNotification('Consultation report editing enabled. Use the form below to edit fields.', 'info');
            } else {
                // Exit edit mode
                disableConsultEditing();
                saveBtn.style.display = 'none';
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Report';
                editBtn.style.background = '';
                editControls.classList.remove('active');
                showNotification('Edit mode cancelled.', 'info');
            }
        }

        function enableConsultEditing() {
            // Store original content
            originalConsultContent = {
                anc: document.getElementById('consult-anc').textContent,
                perinatal: document.getElementById('consult-perinatal').textContent,
                device: document.getElementById('consult-device').textContent,
                suckCycle: document.getElementById('consult-suck-cycle').textContent,
                otherSignificant: document.getElementById('consult-other-significant').textContent,
                echo: document.getElementById('consult-echo').textContent,
                ecg: document.getElementById('consult-ecg').textContent,
                medication1: document.getElementById('consult-medication1').textContent,
                advice: document.getElementById('consult-advice').textContent,
                followup: document.getElementById('consult-followup').textContent,
                indication: document.getElementById('consult-indication').textContent,
                s1: document.getElementById('consult-s1').textContent,
                s2: document.getElementById('consult-s2').textContent,
                murmur: document.getElementById('consult-murmur').textContent,
                ref: document.getElementById('consult-ref').textContent
            };
            
            // Set current values in edit form
            document.getElementById('edit-anc').value = originalConsultContent.anc;
            document.getElementById('edit-perinatal').value = originalConsultContent.perinatal;
            document.getElementById('edit-device').value = originalConsultContent.device;
            document.getElementById('edit-suck-cycle').value = originalConsultContent.suckCycle;
            document.getElementById('edit-other-significant').value = originalConsultContent.otherSignificant;
            document.getElementById('edit-echo').value = originalConsultContent.echo;
            document.getElementById('edit-ecg').value = originalConsultContent.ecg;
            document.getElementById('edit-medication1').value = originalConsultContent.medication1;
            document.getElementById('edit-advice').value = originalConsultContent.advice;
            
            // Set follow-up date (convert "1 week" to actual date)
            if (originalConsultContent.followup === "1 week") {
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                document.getElementById('edit-followup').value = nextWeek.toISOString().split('T')[0];
            } else {
                document.getElementById('edit-followup').value = originalConsultContent.followup;
            }
        }

        function disableConsultEditing() {
            // Restore original content if cancelled
            if (Object.keys(originalConsultContent).length > 0) {
                Object.keys(originalConsultContent).forEach(key => {
                    const element = document.getElementById(`consult-${key}`);
                    if (element) {
                        element.textContent = originalConsultContent[key];
                    }
                });
            }
            
            consultEditMode = false;
        }

        function updateConsultField(field, value) {
            const element = document.getElementById(`consult-${field}`);
            if (element) {
                element.textContent = value;
            }
        }

        function addDropdownOption(field) {
            const input = document.getElementById(`new-${field}-option`);
            const dropdown = document.getElementById(`edit-${field}`);
            
            if (input.value.trim() !== '') {
                const newOption = document.createElement('option');
                newOption.value = input.value;
                newOption.textContent = input.value;
                dropdown.appendChild(newOption);
                
                // Select the new option
                dropdown.value = input.value;
                
                // Update the report field
                updateConsultField(field, input.value);
                
                // Clear the input
                input.value = '';
                
                showNotification(`Option added to ${field} dropdown`, 'success');
            } else {
                showNotification('Please enter an option value', 'error');
            }
        }

        function removeDropdownOption(field) {
            const dropdown = document.getElementById(`edit-${field}`);
            
            if (dropdown.selectedIndex >= 0) {
                const selectedOption = dropdown.options[dropdown.selectedIndex];
                
                // Don't remove if it's the only option
                if (dropdown.options.length > 1) {
                    dropdown.remove(dropdown.selectedIndex);
                    
                    // Select the first option
                    dropdown.selectedIndex = 0;
                    
                    // Update the report field
                    updateConsultField(field, dropdown.value);
                    
                    showNotification(`Option removed from ${field} dropdown`, 'success');
                } else {
                    showNotification('Cannot remove the only option', 'error');
                }
            } else {
                showNotification('Please select an option to remove', 'error');
            }
        }

        function saveConsultReport() {
            // In a real application, you would save to your database here
            // For now, we'll just show a success message
            
            // Reset button states
            const saveBtn = document.getElementById('save-consult-btn');
            const editBtn = document.querySelector('#consult-controls .edit-btn');
            const editControls = document.getElementById('consult-edit-controls');
            
            saveBtn.style.display = 'none';
            editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Report';
            editBtn.style.background = '';
            editControls.classList.remove('active');
            
            consultEditMode = false;
            
            showNotification('Consultation report saved successfully!', 'success');
        }

        // Enhanced PDF Save Functions

        // Function to save Echo Report as PDF with file explorer
        async function saveEchoAsPDF() {
            try {
                // Store current edit mode state
                const wasInEditMode = echoEditMode;
                
                // If in edit mode, exit it temporarily for PDF generation
                if (wasInEditMode) {
                    disableEchoEditing();
                }
                
                // Show file explorer modal
                showFileExplorer('echo');
                
            } catch (error) {
                console.error('Error in PDF generation:', error);
                showNotification('Error generating PDF. Please try again.', 'error');
                
                // Restore edit mode if it was active
                if (wasInEditMode) {
                    setTimeout(() => {
                        toggleEchoEditMode();
                    }, 500);
                }
            }
        }

        // Function to save Consultation Report as PDF with file explorer
        async function saveConsultAsPDF() {
            try {
                // Store current edit mode state
                const wasInEditMode = consultEditMode;
                
                // If in edit mode, exit it temporarily for PDF generation
                if (wasInEditMode) {
                    disableConsultEditing();
                }
                
                // Show file explorer modal
                showFileExplorer('consultation');
                
            } catch (error) {
                console.error('Error in PDF generation:', error);
                showNotification('Error generating PDF. Please try again.', 'error');
                
                // Restore edit mode if it was active
                if (wasInEditMode) {
                    setTimeout(() => {
                        toggleConsultEditMode();
                    }, 500);
                }
            }
        }

        // File Explorer Functions
        function showFileExplorer(reportType) {
            currentReportType = reportType;
            const modal = document.getElementById('file-explorer-modal');
            const modalTitle = document.getElementById('file-explorer-title');
            
            // Set modal title based on report type
            modalTitle.textContent = `Save ${reportType === 'echo' ? 'Echo' : 'Consultation'} Report As`;
            
            // Reset to default location
            currentLocation = 'Downloads';
            currentPath = ['This PC', 'Downloads'];
            
            // Generate filename based on patient info
            let fileName = '';
            if (reportType === 'echo') {
                const patientId = document.getElementById('echo-patient-id').textContent || 'unknown';
                const patientName = document.getElementById('echo-patient-name').textContent || 'echo_report';
                const reportDate = document.getElementById('echo-report-date').textContent.replace('Date: ', '') || new Date().toISOString().split('T')[0];
                fileName = `Echo_${patientId}_${patientName.replace(/\s+/g, '_')}_${reportDate.replace(/\//g, '-')}.pdf`;
            } else {
                const patientId = document.getElementById('consult-patient-id').textContent || 'unknown';
                const patientName = document.getElementById('consult-patient-name').textContent || 'consult_report';
                const reportDate = document.getElementById('consult-report-date-value').textContent || new Date().toISOString().split('T')[0];
                fileName = `Consult_${patientId}_${patientName.replace(/\s+/g, '_')}_${reportDate.replace(/\//g, '-')}.pdf`;
            }
            
            document.getElementById('file-name-input').value = fileName;
            
            // Update the file explorer view
            updateFileExplorerView();
            
            // Show the modal
            modal.classList.add('active');
        }

        function closeFileExplorer() {
            document.getElementById('file-explorer-modal').classList.remove('active');
        }

        function updateFileExplorerView() {
            // Update path display
            document.getElementById('current-path').textContent = currentPath.join(' > ');
            document.getElementById('current-location').textContent = currentPath.join(' > ');
            
            // Get current location in file system
            let currentLocationData = fileSystem;
            for (const pathPart of currentPath) {
                if (currentLocationData[pathPart]) {
                    currentLocationData = currentLocationData[pathPart];
                }
            }
            
            // Clear containers
            const foldersContainer = document.getElementById('folders-container');
            const filesContainer = document.getElementById('files-container');
            foldersContainer.innerHTML = '';
            filesContainer.innerHTML = '';
            
            // Add folders
            Object.keys(currentLocationData).forEach(key => {
                if (currentLocationData[key].type === 'folder') {
                    const folderElement = document.createElement('div');
                    folderElement.className = 'file-explorer-folder';
                    folderElement.innerHTML = `
                        <i class="fas fa-folder"></i>
                        <span>${key}</span>
                    `;
                    folderElement.onclick = () => navigateToFolder(key);
                    foldersContainer.appendChild(folderElement);
                }
            });
            
            // Add files
            Object.keys(currentLocationData).forEach(key => {
                if (currentLocationData[key].type === 'file') {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'file-explorer-file';
                    fileElement.innerHTML = `
                        <div class="name">
                            <i class="fas fa-file-pdf"></i>
                            <span>${key}</span>
                        </div>
                        <div class="date">${currentLocationData[key].date}</div>
                        <div class="size">${currentLocationData[key].size}</div>
                    `;
                    fileElement.onclick = () => {
                        // Remove selection from all files
                        document.querySelectorAll('.file-explorer-file').forEach(file => {
                            file.classList.remove('selected');
                        });
                        // Add selection to clicked file
                        fileElement.classList.add('selected');
                        // Set filename to selected file
                        document.getElementById('file-name-input').value = key;
                    };
                    filesContainer.appendChild(fileElement);
                }
            });
            
            // If no folders or files, show message
            if (foldersContainer.children.length === 0 && filesContainer.children.length === 0) {
                foldersContainer.innerHTML = '<p style="text-align: center; color: var(--secondary); width: 100%;">This folder is empty</p>';
            }
        }

        function navigateToFolder(folderName) {
            currentPath.push(folderName);
            updateFileExplorerView();
        }

        function navigateUp() {
            if (currentPath.length > 2) { // Don't navigate above "This PC"
                currentPath.pop();
                updateFileExplorerView();
            }
        }

        // Enhanced PDF generation with file explorer
        async function savePDFWithFileExplorer() {
            const fileName = document.getElementById('file-name-input').value;
            if (!fileName) {
                showNotification('Please enter a file name.', 'error');
                return;
            }
            
            // Ensure the filename has .pdf extension
            const finalFileName = fileName.endsWith('.pdf') ? fileName : `${fileName}.pdf`;
            
            try {
                showNotification('Generating PDF... Please wait.', 'info');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Get the report element based on report type
                const reportElement = currentReportType === 'echo' 
                    ? document.getElementById('report-page')
                    : document.getElementById('consultation-report-page');
                
                // Create a clone of the report element to modify for PDF
                const reportClone = reportElement.cloneNode(true);
                
                // Hide headers, footers, and patient details in the clone
                const elementsToHide = reportClone.querySelectorAll(
                    '.report-header, .report-doctors, .report-footer, .report-patient-info, .report-signature'
                );
                
                elementsToHide.forEach(el => {
                    el.style.display = 'none';
                });
                
                // Show only the middle content (report body)
                const reportBody = reportClone.querySelector('.report-body');
                if (reportBody) {
                    reportBody.style.marginTop = '10mm';
                }
                
                // Append the clone to body temporarily (but keep it hidden)
                reportClone.style.position = 'absolute';
                reportClone.style.left = '-9999px';
                reportClone.style.top = '0';
                document.body.appendChild(reportClone);
                
                // Use html2canvas to capture only the middle content
                const canvas = await html2canvas(reportClone, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                // Remove the clone from DOM
                document.body.removeChild(reportClone);
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                let heightLeft = imgHeight;
                let position = 0;
                
                // Add first page
                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Add additional pages if needed
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Use File System Access API if available for native file explorer
                if ('showSaveFilePicker' in window) {
                    try {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: finalFileName,
                            types: [{
                                description: 'PDF Files',
                                accept: {'application/pdf': ['.pdf']}
                            }]
                        });
                        
                        const writable = await fileHandle.createWritable();
                        const pdfBlob = doc.output('blob');
                        await writable.write(pdfBlob);
                        await writable.close();
                        
                        showNotification(`Report saved successfully as ${finalFileName}!`, 'success');
                        closeFileExplorer();
                    } catch (saveError) {
                        if (saveError.name !== 'AbortError') {
                            // User cancelled or API not supported, fallback to download
                            doc.save(finalFileName);
                            showNotification(`Report saved as ${finalFileName}!`, 'success');
                            closeFileExplorer();
                        }
                    }
                } else {
                    // Fallback for browsers without File System Access API
                    doc.save(finalFileName);
                    showNotification(`Report saved as ${finalFileName}!`, 'success');
                    closeFileExplorer();
                }
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('Error generating PDF. Please try again.', 'error');
            }
        }

        // UPDATED PRINT FUNCTIONS - Only print middle content
        function printEchoReport() {
            // Create a temporary print-friendly version
            const reportElement = document.getElementById('report-page');
            const printClone = reportElement.cloneNode(true);
            
            // Hide elements that shouldn't be printed
            const elementsToHide = printClone.querySelectorAll(
                '.report-header, .report-doctors, .report-footer, .report-patient-info, .report-signature'
            );
            
            elementsToHide.forEach(el => {
                el.style.display = 'none';
            });
            
            // Adjust the report body for printing
            const reportBody = printClone.querySelector('.report-body');
            if (reportBody) {
                reportBody.style.marginTop = '0';
                reportBody.style.paddingTop = '0';
            }
            
            // Create a temporary container for printing
            const printContainer = document.createElement('div');
            printContainer.style.cssText = `
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 10000;
                padding: 20mm;
                overflow: auto;
            `;
            printContainer.appendChild(printClone);
            
            document.body.appendChild(printContainer);
            
            // Print and then remove the temporary container
            window.print();
            
            setTimeout(() => {
                document.body.removeChild(printContainer);
            }, 500);
        }

        function printConsultReport() {
            // Create a temporary print-friendly version
            const reportElement = document.getElementById('consultation-report-page');
            const printClone = reportElement.cloneNode(true);
            
            // Hide elements that shouldn't be printed
            const elementsToHide = printClone.querySelectorAll(
                '.report-header, .report-doctors, .report-footer, .report-patient-info, .report-signature'
            );
            
            elementsToHide.forEach(el => {
                el.style.display = 'none';
            });
            
            // Adjust the report body for printing
            const reportBody = printClone.querySelector('.report-body');
            if (reportBody) {
                reportBody.style.marginTop = '0';
                reportBody.style.paddingTop = '0';
            }
            
            // Create a temporary container for printing
            const printContainer = document.createElement('div');
            printContainer.style.cssText = `
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 10000;
                padding: 20mm;
                overflow: auto;
            `;
            printContainer.appendChild(printClone);
            
            document.body.appendChild(printContainer);
            
            // Print and then remove the temporary container
            window.print();
            
            setTimeout(() => {
                document.body.removeChild(printContainer);
            }, 500);
        }

        // Function to save patients data to localStorage
        function savePatientsToStorage() {
            localStorage.setItem('vamaPatients', JSON.stringify(patients));
        }

        // Function to update UI based on user role
        function updateUIForUserRole() {
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            const isAdmin = currentUserRole === 'admin';
            const permissions = rolePermissions[currentUserRole];
            
            // Show/hide admin-only elements
            adminOnlyElements.forEach(element => {
                if (isAdmin) {
                    element.style.display = '';
                } else {
                    element.style.display = 'none';
                }
            });
            
            // Update sidebar menu based on role
            updateSidebarMenu(permissions.mainMenu);
            
            // Update mobile navigation
            updateMobileNavigation(permissions.mainMenu);
        }

        // Function to update sidebar menu based on permissions
        function updateSidebarMenu(allowedPages) {
            const menuItems = document.querySelectorAll('.sidebar-menu a');
            
            menuItems.forEach(item => {
                const page = item.getAttribute('data-page');
                if (allowedPages.includes(page)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Function to update mobile navigation based on permissions
        function updateMobileNavigation(allowedPages) {
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            
            bottomNavItems.forEach(item => {
                const page = item.getAttribute('data-page');
                if (allowedPages.includes(page)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Function to navigate to specific page with role check
        function navigateToPage(pageId) {
            const permissions = rolePermissions[currentUserRole];
            
            // Check if user has access to this page
            if (!permissions.accessiblePages.includes(pageId)) {
                showNotification('Access denied. You do not have permission to access this page.', 'error');
                return;
            }
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu a, .bottom-nav-item').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(`${pageId}-page`).classList.add('active');
            
            // Update active menu items only if they are visible
            const sidebarItem = document.querySelector(`.sidebar-menu a[data-page="${pageId}"]`);
            const bottomNavItem = document.querySelector(`.bottom-nav-item[data-page="${pageId}"]`);
            
            if (sidebarItem && sidebarItem.style.display !== 'none') {
                sidebarItem.classList.add('active');
            }
            
            if (bottomNavItem && bottomNavItem.style.display !== 'none') {
                bottomNavItem.classList.add('active');
            }

            if (pageId === 'appointments') {
                updateAppointmentsTable();
            } else if (pageId === 'database') {
                updateDatabaseTable();
            }

            if (window.innerWidth <= 992) {
                closeSidebar();
            }
        }

        // Admin password verification
        function verifyAdminPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === '1') {
                currentUserRole = 'admin';
                document.getElementById('user-name').innerHTML = 'Admin User <span class="role-badge role-admin">Admin</span>';
                document.getElementById('user-profile').querySelector('img').src = 'https://ui-avatars.com/api/?name=Admin+User&background=2563eb&color=fff';
                
                // Update UI for admin role
                updateUIForUserRole();
                
                // Close modal
                closeAdminModal();
                
                showNotification('Admin access granted!', 'success');
            } else {
                showNotification('Incorrect password. Please try again.', 'error');
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-password').focus();
            }
        }

        // Open admin modal
        function openAdminModal() {
            document.getElementById('admin-modal').classList.add('active');
            document.getElementById('admin-password').focus();
        }

        // Close admin modal
        function closeAdminModal() {
            document.getElementById('admin-modal').classList.remove('active');
            document.getElementById('admin-password').value = '';
        }

        // Mobile number validation function
        function validateMobileNumber() {
            const mobileInput = document.getElementById('mobile');
            const mobileError = document.getElementById('mobile-error');
            const mobileValue = mobileInput.value.trim();
            
            // Check if mobile number is exactly 10 digits
            const mobileRegex = /^\d{10}$/;
            
            if (mobileValue && !mobileRegex.test(mobileValue)) {
                mobileError.classList.add('show');
                mobileInput.style.borderColor = '#ef4444';
                return false;
            } else {
                mobileError.classList.remove('show');
                mobileInput.style.borderColor = '#ddd';
                return true;
            }
        }

        // Form submission handler
        document.getElementById('patientForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Validate mobile number
            if (!validateMobileNumber()) {
                showNotification('Please enter a valid 10-digit mobile number.', 'error');
                return;
            }

            // Get form values
            const newPatient = {
                id: document.getElementById('patientId').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                sex: document.getElementById('sex').value,
                dob: document.getElementById('dob').value,
                email: document.getElementById('email').value,
                mobile: document.getElementById('mobile').value,
                address: document.getElementById('address').value,
                weight: document.getElementById('weight').value,
                height: document.getElementById('height').value,
                bloodPressure: document.getElementById('bloodPressure').value,
                heartRate: document.getElementById('heartRate').value,
                spo2: document.getElementById('spo2').value,
                appointmentDate: document.getElementById('appointmentDate').value,
                appointmentTime: document.getElementById('appointmentTime').value,
                status: 'scheduled',
                echoReports: [],
                consultations: [],
                followUps: []
            };

            // Add patient to array
            patients.push(newPatient);

            // Save to localStorage
            savePatientsToStorage();

            showNotification('Patient registration submitted successfully!', 'success');

            // Clear form and generate new ID
            clearForm();
            generateNewPatientId();

            // Navigate to appointments page
            navigateToPage('appointments');
        });

        // Clear form function
        function clearForm() {
            if (confirm('Are you sure you want to clear all form data?')) {
                document.getElementById('patientForm').reset();
                generateNewPatientId();
                
                // Set default appointment date to today
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                document.getElementById('appointmentDate').value = formattedDate;
            }
        }

        // Generate new patient ID
        function generateNewPatientId() {
            if (patients.length > 0) {
                const lastId = parseInt(patients[patients.length - 1].id);
                const newId = lastId + 1;
                document.getElementById('patientId').value = newId;
            } else {
                document.getElementById('patientId').value = "5041174";
            }
        }

        // Update appointments table
        function updateAppointmentsTable() {
            const tableBody = document.getElementById('appointmentsTableBody');
            const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;

            tableBody.innerHTML = '';

            const filteredPatients = patients.filter(patient => {
                const matchesSearch =
                    patient.id.toLowerCase().includes(searchTerm) ||
                    `${patient.firstName} ${patient.lastName}`.toLowerCase().includes(searchTerm) ||
                    patient.mobile.includes(searchTerm);

                let matchesStatus = true;
                if (statusFilter === 'follow-up') {
                    matchesStatus = patient.followUps && patient.followUps.length > 0;
                } else if (statusFilter !== 'all') {
                    matchesStatus = patient.status === statusFilter;
                }

                return matchesSearch && matchesStatus;
            });

            filteredPatients.forEach(patient => {
                const age = calculateAge(patient.dob);
                const nextFollowUp = patient.followUps && patient.followUps.length > 0 
                    ? patient.followUps[patient.followUps.length - 1] 
                    : null;
                
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${patient.id}</td>
                    <td>${patient.firstName} ${patient.lastName}</td>
                    <td>${patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1)}</td>
                    <td>${age} years</td>
                    <td>${patient.mobile}</td>
                    <td>${formatDate(patient.appointmentDate)}</td>
                    <td>${formatTime(patient.appointmentTime)}</td>
                    <td><span class="status-badge status-${patient.status}">${patient.status.charAt(0).toUpperCase() + patient.status.slice(1)}</span></td>
                    <td>${nextFollowUp ? formatDate(nextFollowUp.date) : 'None'}</td>
                    <td>
                        <div class="action-icons">
                            <button class="action-icon see-icon" onclick="viewPatient('${patient.id}')" title="View Patient">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-icon follow-up-icon" onclick="showFollowUpForm('${patient.id}')" title="Schedule Follow-up">
                                <i class="fas fa-calendar-plus"></i>
                            </button>
                            <button class="action-icon btn-echo" onclick="goToEchoReport('${patient.id}')" title="Go to Echo Report">
                                <i class="fas fa-heartbeat"></i>
                            </button>
                            <button class="action-icon btn-consult" onclick="goToConsultReport('${patient.id}')" title="Go to Consultant Report">
                                <i class="fas fa-user-md"></i>
                            </button>
                        </div>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            if (filteredPatients.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="10" style="text-align: center;">No appointments found</td>`;
                tableBody.appendChild(row);
            }
        }

        // Update database table
        function updateDatabaseTable() {
            const tableBody = document.getElementById('databaseTableBody');
            const searchTerm = document.getElementById('searchDatabase').value.toLowerCase();
            const filterType = document.getElementById('filterDatabase').value;

            tableBody.innerHTML = '';

            const filteredPatients = patients.filter(patient => {
                const matchesSearch =
                    patient.id.toLowerCase().includes(searchTerm) ||
                    `${patient.firstName} ${patient.lastName}`.toLowerCase().includes(searchTerm) ||
                    patient.mobile.includes(searchTerm);

                let matchesType = true;
                if (filterType === 'echo') {
                    matchesType = patient.echoReports.length > 0;
                } else if (filterType === 'consultation') {
                    matchesType = patient.consultations.length > 0;
                }

                return matchesSearch && matchesType;
            });

            filteredPatients.forEach(patient => {
                const age = calculateAge(patient.dob);
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${patient.id}</td>
                    <td>${patient.firstName} ${patient.lastName}</td>
                    <td>${patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1)}</td>
                    <td>${age} years</td>
                    <td>${patient.mobile}</td>
                    <td>${formatDate(patient.appointmentDate)}</td>
                    <td>${patient.echoReports.length} report(s)</td>
                    <td>${patient.consultations.length} report(s)</td>
                    <td>
                        <button class="action-icon btn-edit" onclick="viewPatientDetails('${patient.id}')" title="View Patient Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            if (filteredPatients.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="9" style="text-align: center;">No records found</td>`;
                tableBody.appendChild(row);
            }
        }

        // Helper functions
        function calculateAge(dob) {
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            return age;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function findPatient(searchTerm) {
            return patients.find(patient =>
                patient.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                `${patient.firstName} ${patient.lastName}`.toLowerCase().includes(searchTerm.toLowerCase()) ||
                patient.mobile.includes(searchTerm)
            );
        }

        // Navigation functions
        function goToEchoReport(patientId) {
            const permissions = rolePermissions[currentUserRole];
            
            // Check if user has access to Echo Reports
            if (!permissions.accessiblePages.includes('echo')) {
                showNotification('Access denied. You do not have permission to access Echo Reports.', 'error');
                return;
            }
            
            const patient = findPatient(patientId);
            if (patient) {
                navigateToPage('echo');
                
                document.getElementById('searchEchoPatient').value = patient.id;
                
                searchEchoPatient();
                
                window.scrollTo(0, 0);
            }
        }

        function goToConsultReport(patientId) {
            const permissions = rolePermissions[currentUserRole];
            
            // Check if user has access to Consultation
            if (!permissions.accessiblePages.includes('consultation')) {
                showNotification('Access denied. You do not have permission to access Consultation.', 'error');
                return;
            }
            
            const patient = findPatient(patientId);
            if (patient) {
                navigateToPage('consultation');
                
                document.getElementById('searchConsultPatient').value = patient.id;
                
                searchConsultPatient();
                
                window.scrollTo(0, 0);
            }
        }

        function viewPatient(patientId) {
            const patient = findPatient(patientId);
            if (patient) {
                navigateToPage('registration');
                
                document.getElementById('patientId').value = patient.id;
                document.getElementById('firstName').value = patient.firstName;
                document.getElementById('lastName').value = patient.lastName;
                document.getElementById('sex').value = patient.sex;
                document.getElementById('dob').value = patient.dob;
                document.getElementById('email').value = patient.email;
                document.getElementById('mobile').value = patient.mobile;
                document.getElementById('address').value = patient.address;
                document.getElementById('weight').value = patient.weight;
                document.getElementById('height').value = patient.height;
                document.getElementById('bloodPressure').value = patient.bloodPressure;
                document.getElementById('heartRate').value = patient.heartRate;
                document.getElementById('spo2').value = patient.spo2;
                document.getElementById('appointmentDate').value = patient.appointmentDate;
                document.getElementById('appointmentTime').value = patient.appointmentTime;
                
                window.scrollTo(0, 0);
            }
        }

        function viewPatientDetails(patientId) {
            const patient = findPatient(patientId);
            if (patient) {
                alert(`Patient Details:\n\nID: ${patient.id}\nName: ${patient.firstName} ${patient.lastName}\nSex: ${patient.sex}\nAge: ${calculateAge(patient.dob)} years\nMobile: ${patient.mobile}\nEcho Reports: ${patient.echoReports.length}\nConsultations: ${patient.consultations.length}`);
            }
        }

        // Search functions
        function searchEchoPatient() {
            const searchTerm = document.getElementById('searchEchoPatient').value.trim();
            if (!searchTerm) {
                showNotification('Please enter a patient ID or name to search.', 'error');
                return;
            }

            const patient = findPatient(searchTerm);
            if (patient) {
                document.getElementById('echo-patient-id').textContent = patient.id;
                document.getElementById('echo-patient-name').textContent = `${patient.firstName} ${patient.lastName}`;
                document.getElementById('echo-patient-age').textContent = `${calculateAge(patient.dob)} years / ${patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1)}`;
                document.getElementById('echo-patient-weight').textContent = `${patient.weight} Kg`;
                document.getElementById('echo-patient-bp').textContent = patient.bloodPressure;
                document.getElementById('echo-patient-hr').textContent = `${patient.heartRate} BPM`;

                const today = new Date();
                const formattedDate = today.getDate().toString().padStart(2, '0') + '-' +
                    (today.getMonth() + 1).toString().padStart(2, '0') + '-' +
                    today.getFullYear();
                document.getElementById('echo-report-date').textContent = formattedDate;

                showNotification(`Patient found: ${patient.firstName} ${patient.lastName}`, 'success');
            } else {
                showNotification('Patient not found. Please check the ID or name and try again.', 'error');
            }
        }

        function searchConsultPatient() {
            const searchTerm = document.getElementById('searchConsultPatient').value.trim();
            if (!searchTerm) {
                showNotification('Please enter a patient ID or name to search.', 'error');
                return;
            }

            const patient = findPatient(searchTerm);
            if (patient) {
                document.getElementById('consult-patient-id').textContent = patient.id;
                document.getElementById('consult-patient-name').textContent = `${patient.firstName} ${patient.lastName}`;
                document.getElementById('consult-patient-age').textContent = `${calculateAge(patient.dob)} years / ${patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1)}`;

                const today = new Date();
                const formattedDate = today.getDate().toString().padStart(2, '0') + '-' +
                    (today.getMonth() + 1).toString().padStart(2, '0') + '-' +
                    today.getFullYear();
                document.getElementById('consult-report-date-value').textContent = formattedDate;

                showNotification(`Patient found: ${patient.firstName} ${patient.lastName}`, 'success');
            } else {
                showNotification('Patient not found. Please check the ID or name and try again.', 'error');
            }
        }

        // Follow-up functions
        let currentFollowUpPatient = null;

        function showFollowUpForm(patientId) {
            const patient = findPatient(patientId);
            if (patient) {
                currentFollowUpPatient = patient;
                document.getElementById('follow-up-patient-id').value = patient.id;
                document.getElementById('follow-up-patient-name').value = `${patient.firstName} ${patient.lastName}`;
                
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                document.getElementById('follow-up-date').value = nextWeek.toISOString().split('T')[0];
                
                document.getElementById('follow-up-form').classList.add('active');
                
                document.querySelector('.follow-up-section').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }

        function saveFollowUp() {
            if (!currentFollowUpPatient) return;
            
            const followUpDate = document.getElementById('follow-up-date').value;
            const followUpTime = document.getElementById('follow-up-time').value;
            const followUpReason = document.getElementById('follow-up-reason').value;
            
            if (!followUpDate || !followUpTime) {
                showNotification('Please select both date and time for follow-up.', 'error');
                return;
            }
            
            const followUp = {
                date: followUpDate,
                time: followUpTime,
                reason: followUpReason,
                status: 'scheduled'
            };
            
            if (!currentFollowUpPatient.followUps) {
                currentFollowUpPatient.followUps = [];
            }
            
            currentFollowUpPatient.followUps.push(followUp);
            
            savePatientsToStorage();
            updateAppointmentsTable();
            updateFollowUpTable();
            
            cancelFollowUp();
            
            showNotification('Follow-up scheduled successfully!', 'success');
        }

        function cancelFollowUp() {
            document.getElementById('follow-up-form').classList.remove('active');
            document.getElementById('follow-up-date').value = '';
            document.getElementById('follow-up-time').value = '';
            document.getElementById('follow-up-reason').value = '';
            currentFollowUpPatient = null;
        }

        function updateFollowUpTable() {
            const tableBody = document.getElementById('follow-up-table-body');
            tableBody.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            let allFollowUps = [];
            
            patients.forEach(patient => {
                if (patient.followUps && Array.isArray(patient.followUps)) {
                    patient.followUps.forEach(followUp => {
                        if (followUp.date >= today && followUp.status === 'scheduled') {
                            allFollowUps.push({
                                patientId: patient.id,
                                patientName: `${patient.firstName} ${patient.lastName}`,
                                ...followUp
                            });
                        }
                    });
                }
            });
            
            allFollowUps.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            allFollowUps.forEach(followUp => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${followUp.patientId}</td>
                    <td>${followUp.patientName}</td>
                    <td>${formatDate(followUp.date)}</td>
                    <td>${formatTime(followUp.time)}</td>
                    <td>${followUp.reason}</td>
                    <td>
                        <div class="action-icons">
                            <button class="action-icon see-icon" onclick="viewPatient('${followUp.patientId}')" title="View Patient">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (allFollowUps.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center;">No upcoming follow-ups</td>`;
                tableBody.appendChild(row);
            }
        }

        // Export functions
        function exportAppointmentsToExcel() {
            const worksheetData = [
                ['Patient ID', 'Name', 'Sex', 'Age', 'Mobile', 'Appointment Date', 'Appointment Time', 'Status', 'Next Follow-up']
            ];
            
            patients.forEach(patient => {
                const age = calculateAge(patient.dob);
                const nextFollowUp = patient.followUps && patient.followUps.length > 0 
                    ? patient.followUps[patient.followUps.length - 1] 
                    : null;
                    
                worksheetData.push([
                    patient.id,
                    `${patient.firstName} ${patient.lastName}`,
                    patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1),
                    `${age} years`,
                    patient.mobile,
                    formatDate(patient.appointmentDate),
                    formatTime(patient.appointmentTime),
                    patient.status.charAt(0).toUpperCase() + patient.status.slice(1),
                    nextFollowUp ? formatDate(nextFollowUp.date) : 'None'
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            
            XLSX.utils.book_append_sheet(wb, ws, 'Appointments');
            
            XLSX.writeFile(wb, `VAMA_Appointments_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('Appointments exported to Excel successfully!', 'success');
        }

        function exportPatientDataToExcel() {
            const worksheetData = [
                ['Patient ID', 'First Name', 'Last Name', 'Sex', 'Date of Birth', 'Age', 'Email', 'Mobile', 'Address', 
                 'Weight (kg)', 'Height (cm)', 'Blood Pressure', 'Heart Rate', 'SpO2', 'Registration Date']
            ];
            
            patients.forEach(patient => {
                const age = calculateAge(patient.dob);
                
                worksheetData.push([
                    patient.id,
                    patient.firstName,
                    patient.lastName,
                    patient.sex.charAt(0).toUpperCase() + patient.sex.slice(1),
                    patient.dob,
                    `${age} years`,
                    patient.email,
                    patient.mobile,
                    patient.address,
                    patient.weight,
                    patient.height,
                    patient.bloodPressure,
                    patient.heartRate,
                    patient.spo2,
                    formatDate(patient.appointmentDate)
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            
            XLSX.utils.book_append_sheet(wb, ws, 'Patient Data');
            
            XLSX.writeFile(wb, `VAMA_Patient_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('Patient data exported to Excel successfully!', 'success');
        }

        // Mobile sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Style the notification
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 300px;
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // NEW FUNCTIONS FOR ECHO REPORT CONTROLS
        let echoEditMode = false;
        let originalEchoContent = {};

        function toggleEchoEditMode() {
            echoEditMode = !echoEditMode;
            const saveBtn = document.getElementById('save-echo-btn');
            const editBtn = document.querySelector('#echo-controls .edit-btn');
            
            if (echoEditMode) {
                // Enter edit mode
                enableEchoEditing();
                saveBtn.style.display = 'flex';
                editBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Edit';
                editBtn.style.background = '#6c757d';
                showNotification('Echo report editing enabled. Click on any text to edit.', 'info');
            } else {
                // Exit edit mode
                disableEchoEditing();
                saveBtn.style.display = 'none';
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Report';
                editBtn.style.background = '';
                showNotification('Edit mode cancelled.', 'info');
            }
        }

        function enableEchoEditing() {
            // Store original content
            originalEchoContent = {
                diagnosis: document.getElementById('echo-diagnosis').innerHTML,
                impression: document.getElementById('echo-impression').innerHTML,
                indication: document.getElementById('echo-indication').textContent,
                ref: document.getElementById('echo-ref').textContent
            };
            
            // Make content editable
            document.getElementById('echo-diagnosis').contentEditable = true;
            document.getElementById('echo-impression').contentEditable = true;
            document.getElementById('echo-indication').contentEditable = true;
            document.getElementById('echo-ref').contentEditable = true;
            
            // Add visual indication
            document.querySelectorAll('#echo-diagnosis, #echo-impression, #echo-indication, #echo-ref').forEach(el => {
                el.style.border = '1px dashed #3b82f6';
                el.style.padding = '5px';
                el.style.borderRadius = '4px';
                el.style.backgroundColor = '#f0f9ff';
            });
            
            // Show preset controls
            document.getElementById('echo-preset-controls').style.display = 'block';
        }

        function disableEchoEditing() {
            // Restore original content if cancelled
            if (Object.keys(originalEchoContent).length > 0) {
                document.getElementById('echo-diagnosis').innerHTML = originalEchoContent.diagnosis;
                document.getElementById('echo-impression').innerHTML = originalEchoContent.impression;
                document.getElementById('echo-indication').textContent = originalEchoContent.indication;
                document.getElementById('echo-ref').textContent = originalEchoContent.ref;
            }
            
            // Remove editing capabilities
            document.getElementById('echo-diagnosis').contentEditable = false;
            document.getElementById('echo-impression').contentEditable = false;
            document.getElementById('echo-indication').contentEditable = false;
            document.getElementById('echo-ref').contentEditable = false;
            
            // Remove visual indication
            document.querySelectorAll('#echo-diagnosis, #echo-impression, #echo-indication, #echo-ref').forEach(el => {
                el.style.border = 'none';
                el.style.padding = '0';
                el.style.borderRadius = '0';
                el.style.backgroundColor = 'transparent';
            });
            
            // Hide preset controls
            document.getElementById('echo-preset-controls').style.display = 'none';
            
            echoEditMode = false;
        }

        function saveEchoReport() {
            // In a real application, you would save to your database here
            // For now, we'll just show a success message
            
            // Remove editing capabilities
            document.getElementById('echo-diagnosis').contentEditable = false;
            document.getElementById('echo-impression').contentEditable = false;
            document.getElementById('echo-indication').contentEditable = false;
            document.getElementById('echo-ref').contentEditable = false;
            
            // Remove visual indication
            document.querySelectorAll('#echo-diagnosis, #echo-impression, #echo-indication, #echo-ref').forEach(el => {
                el.style.border = 'none';
                el.style.padding = '0';
                el.style.borderRadius = '0';
                el.style.backgroundColor = 'transparent';
            });
            
            // Reset button states
            const saveBtn = document.getElementById('save-echo-btn');
            const editBtn = document.querySelector('#echo-controls .edit-btn');
            saveBtn.style.display = 'none';
            editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Report';
            editBtn.style.background = '';
            
            // Hide preset controls
            document.getElementById('echo-preset-controls').style.display = 'none';
            
            echoEditMode = false;
            
            showNotification('Echo report saved successfully!', 'success');
        }

        // Function to apply echo preset
        function applyEchoPreset(presetName) {
            if (!echoEditMode) {
                showNotification('Please enable edit mode first to apply presets.', 'error');
                return;
            }
            
            const preset = echoPresets[presetName];
            if (preset) {
                document.getElementById('echo-diagnosis').innerHTML = preset.diagnosis.replace(/\n/g, '<br>');
                document.getElementById('echo-impression').innerHTML = preset.impression.replace(/\n/g, '<br>');
                showNotification(`${presetName} preset applied successfully!`, 'success');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const userProfile = document.getElementById('user-profile');
            const userDropdown = document.getElementById('user-dropdown');
            const dropdownItems = document.querySelectorAll('.user-dropdown-item');

            // Set default appointment date to today
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('appointmentDate').value = formattedDate;

            // Initialize appointments table
            updateAppointmentsTable();

            // Initialize database table
            updateDatabaseTable();

            // Initialize follow-up table
            updateFollowUpTable();

            // Update UI for current user role
            updateUIForUserRole();

            // Add mobile number validation event listener
            document.getElementById('mobile').addEventListener('input', validateMobileNumber);
            document.getElementById('mobile').addEventListener('blur', validateMobileNumber);

            // Toggle mobile sidebar
            mobileMenuToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleSidebar();
            });

            // Close sidebar when clicking on overlay
            sidebarOverlay.addEventListener('click', function() {
                closeSidebar();
            });

            // Toggle user dropdown
            userProfile.addEventListener('click', function(e) {
                e.stopPropagation();
                userDropdown.classList.toggle('active');
            });

            // Close dropdown when clicking elsewhere
            document.addEventListener('click', function() {
                userDropdown.classList.remove('active');
            });

            // Handle role selection
            dropdownItems.forEach(item => {
                item.addEventListener('click', function() {
                    const role = this.getAttribute('data-role');

                    dropdownItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');

                    if (role === 'admin') {
                        // Show admin password modal
                        openAdminModal();
                    } else {
                        currentUserRole = 'receptionist';
                        document.getElementById('user-name').innerHTML = 'Receptionist <span class="role-badge role-receptionist">Receptionist</span>';
                        document.getElementById('user-profile').querySelector('img').src = 'https://ui-avatars.com/api/?name=Receptionist&background=10b981&color=fff';
                        
                        // Update UI based on new role
                        updateUIForUserRole();
                        
                        showNotification('Switched to receptionist role', 'success');
                    }

                    userDropdown.classList.remove('active');
                });
            });

            // Add navigation event listeners
            document.querySelectorAll('.sidebar-menu a, .bottom-nav-item').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();

                    const pageId = this.getAttribute('data-page');
                    navigateToPage(pageId);
                });
            });

            // Add search and filter event listeners
            document.getElementById('searchPatient').addEventListener('input', updateAppointmentsTable);
            document.getElementById('filterStatus').addEventListener('change', updateAppointmentsTable);
            document.getElementById('searchDatabase').addEventListener('input', updateDatabaseTable);
            document.getElementById('filterDatabase').addEventListener('change', updateDatabaseTable);

            // Initialize file explorer event listeners
            const fileExplorerModal = document.getElementById('file-explorer-modal');
            const closeBtn = fileExplorerModal.querySelector('.close');
            
            // Close modal when clicking close button
            closeBtn.addEventListener('click', closeFileExplorer);
            
            // Close modal when clicking outside
            fileExplorerModal.addEventListener('click', function(e) {
                if (e.target === fileExplorerModal) {
                    closeFileExplorer();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && fileExplorerModal.classList.contains('active')) {
                    closeFileExplorer();
                }
            });
        });
    </script>
</body>
</html>